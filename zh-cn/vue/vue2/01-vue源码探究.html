<!DOCTYPE html>
<html lang="en-US">
  <head>
    <meta charset="utf-8">
    <meta name="viewport" content="width=device-width,initial-scale=1">
    <title>Vue2.x 源码 | 前端开发</title>
    <meta name="generator" content="VuePress 1.8.2">
    <link rel="icon" href="/my_boke/logo_42x42.png">
    <meta name="description" content="记录前端使用的技术">
    
    <link rel="preload" href="/my_boke/assets/css/0.styles.1dc4f169.css" as="style"><link rel="preload" href="/my_boke/assets/js/app.5a7cfdf9.js" as="script"><link rel="preload" href="/my_boke/assets/js/2.1e45f81f.js" as="script"><link rel="preload" href="/my_boke/assets/js/24.bfdc09b5.js" as="script"><link rel="prefetch" href="/my_boke/assets/js/10.bfc1846c.js"><link rel="prefetch" href="/my_boke/assets/js/11.fb7352a2.js"><link rel="prefetch" href="/my_boke/assets/js/12.de3c6cdf.js"><link rel="prefetch" href="/my_boke/assets/js/13.42401236.js"><link rel="prefetch" href="/my_boke/assets/js/14.5d084393.js"><link rel="prefetch" href="/my_boke/assets/js/15.ee172a51.js"><link rel="prefetch" href="/my_boke/assets/js/16.323f92b7.js"><link rel="prefetch" href="/my_boke/assets/js/17.0378cc10.js"><link rel="prefetch" href="/my_boke/assets/js/18.b510ebd2.js"><link rel="prefetch" href="/my_boke/assets/js/19.b88ddfe7.js"><link rel="prefetch" href="/my_boke/assets/js/20.b5f521b2.js"><link rel="prefetch" href="/my_boke/assets/js/21.1c070eeb.js"><link rel="prefetch" href="/my_boke/assets/js/22.c99a1cb5.js"><link rel="prefetch" href="/my_boke/assets/js/23.167ea50d.js"><link rel="prefetch" href="/my_boke/assets/js/25.4ad02a79.js"><link rel="prefetch" href="/my_boke/assets/js/26.c34a21bc.js"><link rel="prefetch" href="/my_boke/assets/js/27.1bc57407.js"><link rel="prefetch" href="/my_boke/assets/js/3.ce0460f8.js"><link rel="prefetch" href="/my_boke/assets/js/4.b35d81b3.js"><link rel="prefetch" href="/my_boke/assets/js/5.bdbbe150.js"><link rel="prefetch" href="/my_boke/assets/js/6.df535412.js"><link rel="prefetch" href="/my_boke/assets/js/7.8fd82ea2.js"><link rel="prefetch" href="/my_boke/assets/js/8.84fa2730.js"><link rel="prefetch" href="/my_boke/assets/js/9.33b1d9e0.js">
    <link rel="stylesheet" href="/my_boke/assets/css/0.styles.1dc4f169.css">
  </head>
  <body>
    <div id="app" data-server-rendered="true"><div class="theme-container"><header class="navbar"><div class="sidebar-button"><svg xmlns="http://www.w3.org/2000/svg" aria-hidden="true" role="img" viewBox="0 0 448 512" class="icon"><path fill="currentColor" d="M436 124H12c-6.627 0-12-5.373-12-12V80c0-6.627 5.373-12 12-12h424c6.627 0 12 5.373 12 12v32c0 6.627-5.373 12-12 12zm0 160H12c-6.627 0-12-5.373-12-12v-32c0-6.627 5.373-12 12-12h424c6.627 0 12 5.373 12 12v32c0 6.627-5.373 12-12 12zm0 160H12c-6.627 0-12-5.373-12-12v-32c0-6.627 5.373-12 12-12h424c6.627 0 12 5.373 12 12v32c0 6.627-5.373 12-12 12z"></path></svg></div> <a href="/my_boke/" class="home-link router-link-active"><img src="/my_boke/logo_42x42.png" alt="前端开发" class="logo"> <span class="site-name can-hide">前端开发</span></a> <div class="links"><!----> <nav class="nav-links can-hide"><div class="nav-item"><div class="dropdown-wrapper"><button type="button" aria-label="笔记" class="dropdown-title"><span class="title">笔记</span> <span class="arrow down"></span></button> <button type="button" aria-label="笔记" class="mobile-dropdown-title"><span class="title">笔记</span> <span class="arrow right"></span></button> <ul class="nav-dropdown" style="display:none;"><li class="dropdown-item"><!----> <a href="/my_boke/zh-cn/nodes/other/01-其它笔记.html" class="nav-link">
  随记
</a></li><li class="dropdown-item"><!----> <a href="/my_boke/zh-cn/nodes/js/01-日常开发工具函数.html" class="nav-link">
  JS相关
</a></li><li class="dropdown-item"><!----> <a href="/my_boke/zh-cn/nodes/css/01-日常开发CSS样式类.html" class="nav-link">
  CSS相关
</a></li><li class="dropdown-item"><!----> <a href="/my_boke/zh-cn/nodes/node/" class="nav-link">
  nodejs相关
</a></li></ul></div></div><div class="nav-item"><div class="dropdown-wrapper"><button type="button" aria-label="Vue全家桶" class="dropdown-title"><span class="title">Vue全家桶</span> <span class="arrow down"></span></button> <button type="button" aria-label="Vue全家桶" class="mobile-dropdown-title"><span class="title">Vue全家桶</span> <span class="arrow right"></span></button> <ul class="nav-dropdown" style="display:none;"><li class="dropdown-item"><!----> <a href="/my_boke/zh-cn/vue/vue2/01-vue源码探究.html" class="nav-link">
  vue2.x
</a></li><li class="dropdown-item"><!----> <a href="/my_boke/zh-cn/vue/router/" class="nav-link">
  vue-router
</a></li><li class="dropdown-item"><!----> <a href="/my_boke/zh-cn/vue/vuex/" class="nav-link">
  vuex
</a></li><li class="dropdown-item"><!----> <a href="/my_boke/zh-cn/vue/axios/01-Axios笔记.html" class="nav-link">
  axios
</a></li></ul></div></div><div class="nav-item"><a href="/my_boke/zh-cn/webpack.html" class="nav-link">
  Webpack
</a></div><div class="nav-item"><a href="/my_boke/zh-cn/article/" class="nav-link">
  文章分享
</a></div> <!----></nav></div></header> <div class="sidebar-mask"></div> <aside class="sidebar"><nav class="nav-links"><div class="nav-item"><div class="dropdown-wrapper"><button type="button" aria-label="笔记" class="dropdown-title"><span class="title">笔记</span> <span class="arrow down"></span></button> <button type="button" aria-label="笔记" class="mobile-dropdown-title"><span class="title">笔记</span> <span class="arrow right"></span></button> <ul class="nav-dropdown" style="display:none;"><li class="dropdown-item"><!----> <a href="/my_boke/zh-cn/nodes/other/01-其它笔记.html" class="nav-link">
  随记
</a></li><li class="dropdown-item"><!----> <a href="/my_boke/zh-cn/nodes/js/01-日常开发工具函数.html" class="nav-link">
  JS相关
</a></li><li class="dropdown-item"><!----> <a href="/my_boke/zh-cn/nodes/css/01-日常开发CSS样式类.html" class="nav-link">
  CSS相关
</a></li><li class="dropdown-item"><!----> <a href="/my_boke/zh-cn/nodes/node/" class="nav-link">
  nodejs相关
</a></li></ul></div></div><div class="nav-item"><div class="dropdown-wrapper"><button type="button" aria-label="Vue全家桶" class="dropdown-title"><span class="title">Vue全家桶</span> <span class="arrow down"></span></button> <button type="button" aria-label="Vue全家桶" class="mobile-dropdown-title"><span class="title">Vue全家桶</span> <span class="arrow right"></span></button> <ul class="nav-dropdown" style="display:none;"><li class="dropdown-item"><!----> <a href="/my_boke/zh-cn/vue/vue2/01-vue源码探究.html" class="nav-link">
  vue2.x
</a></li><li class="dropdown-item"><!----> <a href="/my_boke/zh-cn/vue/router/" class="nav-link">
  vue-router
</a></li><li class="dropdown-item"><!----> <a href="/my_boke/zh-cn/vue/vuex/" class="nav-link">
  vuex
</a></li><li class="dropdown-item"><!----> <a href="/my_boke/zh-cn/vue/axios/01-Axios笔记.html" class="nav-link">
  axios
</a></li></ul></div></div><div class="nav-item"><a href="/my_boke/zh-cn/webpack.html" class="nav-link">
  Webpack
</a></div><div class="nav-item"><a href="/my_boke/zh-cn/article/" class="nav-link">
  文章分享
</a></div> <!----></nav>  <ul class="sidebar-links"><li><a href="/my_boke/zh-cn/vue/vue2/01-vue源码探究.html" class="active sidebar-link">vue源码探究</a><ul class="sidebar-sub-headers"><li class="sidebar-sub-header"><a href="/my_boke/zh-cn/vue/vue2/01-vue源码探究.html#选项合并策略" class="sidebar-link">选项合并策略</a><ul class="sidebar-sub-headers"><li class="sidebar-sub-header"><a href="/my_boke/zh-cn/vue/vue2/01-vue源码探究.html#vue-构造器" class="sidebar-link">Vue 构造器</a></li><li class="sidebar-sub-header"><a href="/my_boke/zh-cn/vue/vue2/01-vue源码探究.html#定义原型属性方法" class="sidebar-link">定义原型属性方法</a></li><li class="sidebar-sub-header"><a href="/my_boke/zh-cn/vue/vue2/01-vue源码探究.html#定义静态属性方法" class="sidebar-link">定义静态属性方法</a></li><li class="sidebar-sub-header"><a href="/my_boke/zh-cn/vue/vue2/01-vue源码探究.html#构造器的默认选项" class="sidebar-link">构造器的默认选项</a></li><li class="sidebar-sub-header"><a href="/my_boke/zh-cn/vue/vue2/01-vue源码探究.html#选项检验" class="sidebar-link">选项检验</a></li><li class="sidebar-sub-header"><a href="/my_boke/zh-cn/vue/vue2/01-vue源码探究.html#函数缓存" class="sidebar-link">函数缓存</a></li><li class="sidebar-sub-header"><a href="/my_boke/zh-cn/vue/vue2/01-vue源码探究.html#子类构造器" class="sidebar-link">子类构造器</a></li><li class="sidebar-sub-header"><a href="/my_boke/zh-cn/vue/vue2/01-vue源码探究.html#合并策略" class="sidebar-link">合并策略</a></li><li class="sidebar-sub-header"><a href="/my_boke/zh-cn/vue/vue2/01-vue源码探究.html#常规选项的合并" class="sidebar-link">常规选项的合并</a></li><li class="sidebar-sub-header"><a href="/my_boke/zh-cn/vue/vue2/01-vue源码探究.html#自带资源选项合并" class="sidebar-link">自带资源选项合并</a></li><li class="sidebar-sub-header"><a href="/my_boke/zh-cn/vue/vue2/01-vue源码探究.html#生命周期钩子函数的合并" class="sidebar-link">生命周期钩子函数的合并</a></li><li class="sidebar-sub-header"><a href="/my_boke/zh-cn/vue/vue2/01-vue源码探究.html#watch-选项合并" class="sidebar-link">watch 选项合并</a></li><li class="sidebar-sub-header"><a href="/my_boke/zh-cn/vue/vue2/01-vue源码探究.html#props-methods-inject-computed-合并" class="sidebar-link">props，methods，inject，computed 合并</a></li><li class="sidebar-sub-header"><a href="/my_boke/zh-cn/vue/vue2/01-vue源码探究.html#小结" class="sidebar-link">小结</a></li></ul></li><li class="sidebar-sub-header"><a href="/my_boke/zh-cn/vue/vue2/01-vue源码探究.html#基础的数据代理检测" class="sidebar-link">基础的数据代理检测</a><ul class="sidebar-sub-headers"><li class="sidebar-sub-header"><a href="/my_boke/zh-cn/vue/vue2/01-vue源码探究.html#数据代理的含义" class="sidebar-link">数据代理的含义</a></li><li class="sidebar-sub-header"><a href="/my_boke/zh-cn/vue/vue2/01-vue源码探究.html#object-defineproperty" class="sidebar-link">Object.defineProperty</a></li></ul></li></ul></li></ul> </aside> <main class="page"> <div class="theme-default-content content__default"><h1 id="vue2-x-源码"><a href="#vue2-x-源码" class="header-anchor">#</a> Vue2.x 源码</h1> <h2 id="选项合并策略"><a href="#选项合并策略" class="header-anchor">#</a> 选项合并策略</h2> <h3 id="vue-构造器"><a href="#vue-构造器" class="header-anchor">#</a> Vue 构造器</h3> <p>打包后的源码是遵从<code>UMD</code>规范的，它是<code>commonjs</code>和<code>amd</code>的整合。而<code>Vue</code>的本质是一个构造器,并且它保证了只能通过<code>new</code>实例的形式去调用，而不能直接通过函数的形式使用。</p> <div class="language-js extra-class"><pre class="language-js"><code><span class="token punctuation">(</span><span class="token keyword">function</span> <span class="token punctuation">(</span><span class="token parameter">global<span class="token punctuation">,</span> factory</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
  <span class="token comment">// 遵循UMD规范</span>
  <span class="token keyword">typeof</span> exports <span class="token operator">===</span> <span class="token string">'object'</span> <span class="token operator">&amp;&amp;</span> <span class="token keyword">typeof</span> module <span class="token operator">!==</span> <span class="token string">'undefined'</span> <span class="token operator">?</span> module<span class="token punctuation">.</span>exports <span class="token operator">=</span> <span class="token function">factory</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token operator">:</span>
  <span class="token keyword">typeof</span> define <span class="token operator">===</span> <span class="token string">'function'</span> <span class="token operator">&amp;&amp;</span> define<span class="token punctuation">.</span>amd <span class="token operator">?</span> <span class="token function">define</span><span class="token punctuation">(</span>factory<span class="token punctuation">)</span> <span class="token operator">:</span>
  <span class="token punctuation">(</span>global <span class="token operator">=</span> global <span class="token operator">||</span> self<span class="token punctuation">,</span> global<span class="token punctuation">.</span>Vue <span class="token operator">=</span> <span class="token function">factory</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token punctuation">}</span><span class="token punctuation">(</span><span class="token keyword">this</span><span class="token punctuation">,</span> <span class="token keyword">function</span> <span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">{</span> <span class="token string">'use strict'</span><span class="token punctuation">;</span>
  ···
  <span class="token comment">// Vue 构造函数</span>
  <span class="token keyword">function</span> <span class="token function">Vue</span> <span class="token punctuation">(</span><span class="token parameter">options</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
    <span class="token comment">// 保证了无法直接通过Vue()去调用，只能通过new的方式去创建实例</span>
    <span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token operator">!</span><span class="token punctuation">(</span><span class="token keyword">this</span> <span class="token keyword">instanceof</span> <span class="token class-name">Vue</span><span class="token punctuation">)</span>
    <span class="token punctuation">)</span> <span class="token punctuation">{</span>
      <span class="token function">warn</span><span class="token punctuation">(</span><span class="token string">'Vue is a constructor and should be called with the `new` keyword'</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token punctuation">}</span>
    <span class="token keyword">this</span><span class="token punctuation">.</span><span class="token function">_init</span><span class="token punctuation">(</span>options<span class="token punctuation">)</span><span class="token punctuation">;</span>
  <span class="token punctuation">}</span>
  <span class="token keyword">return</span> Vue
<span class="token punctuation">}</span><span class="token punctuation">)</span>
</code></pre></div><h3 id="定义原型属性方法"><a href="#定义原型属性方法" class="header-anchor">#</a> 定义原型属性方法</h3> <p>首先是原型上的属性方法，在构造函数的定义之后，有这样五个函数，他们分别针对不同场景定义了<code>Vue</code>原型上的属性和方法。</p> <div class="language-js extra-class"><pre class="language-js"><code><span class="token comment">// 定义Vue原型上的init方法(内部方法)</span>
<span class="token function">initMixin</span><span class="token punctuation">(</span>Vue<span class="token punctuation">)</span>
<span class="token comment">// 定义原型上跟数据相关的属性方法</span>
<span class="token function">stateMixin</span><span class="token punctuation">(</span>Vue<span class="token punctuation">)</span>
<span class="token comment">//定义原型上跟事件相关的属性方法</span>
<span class="token function">eventsMixin</span><span class="token punctuation">(</span>Vue<span class="token punctuation">)</span>
<span class="token comment">// 定义原型上跟生命周期相关的方法</span>
<span class="token function">lifecycleMixin</span><span class="token punctuation">(</span>Vue<span class="token punctuation">)</span>
<span class="token comment">// 定义渲染相关的函数</span>
<span class="token function">renderMixin</span><span class="token punctuation">(</span>Vue<span class="token punctuation">)</span>
</code></pre></div><h4 id="initmixin"><a href="#initmixin" class="header-anchor">#</a> initMixin</h4> <p><code>initMixin</code>定义了<strong>内部在实例化<code>Vue</code>时会执行的初始化代码</strong>，它是一个内部使用的方法。</p> <div class="language-js extra-class"><pre class="language-js"><code><span class="token keyword">function</span> <span class="token function">initMixin</span><span class="token punctuation">(</span><span class="token parameter">Vue</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
	<span class="token class-name">Vue</span><span class="token punctuation">.</span>prototype<span class="token punctuation">.</span><span class="token function-variable function">_init</span> <span class="token operator">=</span> <span class="token keyword">function</span><span class="token punctuation">(</span><span class="token parameter">options</span><span class="token punctuation">)</span> <span class="token punctuation">{</span><span class="token punctuation">}</span>
<span class="token punctuation">}</span>
</code></pre></div><h4 id="statemixin"><a href="#statemixin" class="header-anchor">#</a> stateMixin</h4> <p><code>stateMixin</code>方法会定义跟数据相关的属性方法，例如代理数据的访问，我们可以在实例上通过<code>this.$data</code>和<code>this.$props</code>访问到<code>data,props</code>的值，并且也定义了使用频率较高的<code>this.$set,this.$delte</code>等方法。</p> <div class="language-js extra-class"><pre class="language-js"><code><span class="token keyword">function</span> <span class="token function">stateMixin</span><span class="token punctuation">(</span><span class="token parameter">Vue</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
	<span class="token keyword">var</span> dataDef <span class="token operator">=</span> <span class="token punctuation">{</span><span class="token punctuation">}</span>
	dataDef<span class="token punctuation">.</span><span class="token function-variable function">get</span> <span class="token operator">=</span> <span class="token keyword">function</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
		<span class="token keyword">return</span> <span class="token keyword">this</span><span class="token punctuation">.</span>_data
	<span class="token punctuation">}</span>
	<span class="token keyword">var</span> propsDef <span class="token operator">=</span> <span class="token punctuation">{</span><span class="token punctuation">}</span>
	propsDef<span class="token punctuation">.</span><span class="token function-variable function">get</span> <span class="token operator">=</span> <span class="token keyword">function</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
		<span class="token keyword">return</span> <span class="token keyword">this</span><span class="token punctuation">.</span>_props
	<span class="token punctuation">}</span>
	<span class="token punctuation">{</span>
		dataDef<span class="token punctuation">.</span><span class="token function-variable function">set</span> <span class="token operator">=</span> <span class="token keyword">function</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
			<span class="token function">warn</span><span class="token punctuation">(</span><span class="token string">'Avoid replacing instance root $data. '</span> <span class="token operator">+</span> <span class="token string">'Use nested data properties instead.'</span><span class="token punctuation">,</span> <span class="token keyword">this</span><span class="token punctuation">)</span>
		<span class="token punctuation">}</span>
		propsDef<span class="token punctuation">.</span><span class="token function-variable function">set</span> <span class="token operator">=</span> <span class="token keyword">function</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
			<span class="token function">warn</span><span class="token punctuation">(</span><span class="token string">'$props is readonly.'</span><span class="token punctuation">,</span> <span class="token keyword">this</span><span class="token punctuation">)</span>
		<span class="token punctuation">}</span>
	<span class="token punctuation">}</span>
	<span class="token comment">// 代理了_data,_props的访问</span>
	Object<span class="token punctuation">.</span><span class="token function">defineProperty</span><span class="token punctuation">(</span><span class="token class-name">Vue</span><span class="token punctuation">.</span>prototype<span class="token punctuation">,</span> <span class="token string">'$data'</span><span class="token punctuation">,</span> dataDef<span class="token punctuation">)</span>
	Object<span class="token punctuation">.</span><span class="token function">defineProperty</span><span class="token punctuation">(</span><span class="token class-name">Vue</span><span class="token punctuation">.</span>prototype<span class="token punctuation">,</span> <span class="token string">'$props'</span><span class="token punctuation">,</span> propsDef<span class="token punctuation">)</span>
	<span class="token comment">// $set, $del</span>
	<span class="token class-name">Vue</span><span class="token punctuation">.</span>prototype<span class="token punctuation">.</span>$set <span class="token operator">=</span> <span class="token keyword">set</span>
	<span class="token class-name">Vue</span><span class="token punctuation">.</span>prototype<span class="token punctuation">.</span>$<span class="token keyword">delete</span> <span class="token operator">=</span> del

	<span class="token comment">// $watch</span>
	<span class="token class-name">Vue</span><span class="token punctuation">.</span>prototype<span class="token punctuation">.</span><span class="token function-variable function">$watch</span> <span class="token operator">=</span> <span class="token keyword">function</span><span class="token punctuation">(</span><span class="token parameter">expOrFn<span class="token punctuation">,</span> cb<span class="token punctuation">,</span> options</span><span class="token punctuation">)</span> <span class="token punctuation">{</span><span class="token punctuation">}</span>
<span class="token punctuation">}</span>
</code></pre></div><h4 id="eventsmixin"><a href="#eventsmixin" class="header-anchor">#</a> eventsMixin</h4> <p><code>eventsMixin</code>会对原型上的事件相关方法做定义，文档中提到的<code>vm.$on,vm.$once,vm.$off,vm.$emit</code>也就是在这里定义的。</p> <div class="language-js extra-class"><pre class="language-js"><code><span class="token keyword">function</span> <span class="token function">eventsMixin</span><span class="token punctuation">(</span><span class="token parameter">Vue</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
  <span class="token comment">// 自定义事件监听</span>
  <span class="token class-name">Vue</span><span class="token punctuation">.</span>prototype<span class="token punctuation">.</span><span class="token function-variable function">$on</span> <span class="token operator">=</span> <span class="token keyword">function</span> <span class="token punctuation">(</span><span class="token parameter">event<span class="token punctuation">,</span> fn</span><span class="token punctuation">)</span> <span class="token punctuation">{</span><span class="token punctuation">}</span><span class="token punctuation">;</span>
  <span class="token comment">// 自定义事件监听,只触发一次</span>
  <span class="token class-name">Vue</span><span class="token punctuation">.</span>prototype<span class="token punctuation">.</span><span class="token function-variable function">$once</span> <span class="token operator">=</span> <span class="token keyword">function</span> <span class="token punctuation">(</span><span class="token parameter">event<span class="token punctuation">,</span> fn</span><span class="token punctuation">)</span> <span class="token punctuation">{</span><span class="token punctuation">}</span>
  <span class="token comment">// 自定义事件解绑</span>
  <span class="token class-name">Vue</span><span class="token punctuation">.</span>prototype<span class="token punctuation">.</span><span class="token function-variable function">$off</span> <span class="token operator">=</span> <span class="token keyword">function</span> <span class="token punctuation">(</span><span class="token parameter">event<span class="token punctuation">,</span> fn</span><span class="token punctuation">)</span> <span class="token punctuation">{</span><span class="token punctuation">}</span>
  <span class="token comment">// 自定义事件通知</span>
  <span class="token class-name">Vue</span><span class="token punctuation">.</span>prototype<span class="token punctuation">.</span><span class="token function-variable function">$emit</span> <span class="token operator">=</span> <span class="token keyword">function</span> <span class="token punctuation">(</span><span class="token parameter">event<span class="token punctuation">,</span> fn</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
<span class="token punctuation">}</span>
</code></pre></div><h4 id="lifecyclemixin"><a href="#lifecyclemixin" class="header-anchor">#</a> lifecycleMixin</h4> <p><code>lifecycleMixin,renderMixin</code>两个都可以算是对生命周期渲染方法的定义，例如<code>$forceUpdate</code>触发实例的强制刷新，<code>$nextTick</code>将回调延迟到下次 <code>DOM</code> 更新循环之后执行等。</p> <div class="language-js extra-class"><pre class="language-js"><code><span class="token comment">// 定义跟生命周期相关的方法</span>
<span class="token keyword">function</span> <span class="token function">lifecycleMixin</span><span class="token punctuation">(</span><span class="token parameter">Vue</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
	<span class="token class-name">Vue</span><span class="token punctuation">.</span>prototype<span class="token punctuation">.</span><span class="token function-variable function">_update</span> <span class="token operator">=</span> <span class="token keyword">function</span><span class="token punctuation">(</span><span class="token parameter">vnode<span class="token punctuation">,</span> hydrating</span><span class="token punctuation">)</span> <span class="token punctuation">{</span><span class="token punctuation">}</span>

	<span class="token class-name">Vue</span><span class="token punctuation">.</span>prototype<span class="token punctuation">.</span><span class="token function-variable function">$forceUpdate</span> <span class="token operator">=</span> <span class="token keyword">function</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">{</span><span class="token punctuation">}</span>

	<span class="token class-name">Vue</span><span class="token punctuation">.</span>prototype<span class="token punctuation">.</span><span class="token function-variable function">$destroy</span> <span class="token operator">=</span> <span class="token keyword">function</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">{</span><span class="token punctuation">}</span>
<span class="token punctuation">}</span>
</code></pre></div><h4 id="rendermixin"><a href="#rendermixin" class="header-anchor">#</a> renderMixin</h4> <div class="language-js extra-class"><pre class="language-js"><code><span class="token comment">// 定义原型上跟渲染相关的方法</span>
<span class="token keyword">function</span> <span class="token function">renderMixin</span><span class="token punctuation">(</span><span class="token parameter">Vue</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
	<span class="token class-name">Vue</span><span class="token punctuation">.</span>prototype<span class="token punctuation">.</span><span class="token function-variable function">$nextTick</span> <span class="token operator">=</span> <span class="token keyword">function</span><span class="token punctuation">(</span><span class="token parameter">fn</span><span class="token punctuation">)</span> <span class="token punctuation">{</span><span class="token punctuation">}</span>
	<span class="token comment">// _render函数，后面会着重讲</span>
	<span class="token class-name">Vue</span><span class="token punctuation">.</span>prototype<span class="token punctuation">.</span><span class="token function-variable function">_render</span> <span class="token operator">=</span> <span class="token keyword">function</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">{</span><span class="token punctuation">}</span>
<span class="token punctuation">}</span>
</code></pre></div><h3 id="定义静态属性方法"><a href="#定义静态属性方法" class="header-anchor">#</a> 定义静态属性方法</h3> <p>除了原型方法外，<code>Vue</code>还提供了丰富的全局<code>api</code>方法，这些都是在<code>initGlobalAPI</code>中定义的。</p> <div class="language-js extra-class"><pre class="language-js"><code><span class="token comment">/* 初始化构造器的api */</span>
<span class="token keyword">function</span> <span class="token function">initGlobalAPI</span><span class="token punctuation">(</span><span class="token parameter">Vue</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
	<span class="token comment">// config</span>
	<span class="token keyword">var</span> configDef <span class="token operator">=</span> <span class="token punctuation">{</span><span class="token punctuation">}</span>
	configDef<span class="token punctuation">.</span><span class="token function-variable function">get</span> <span class="token operator">=</span> <span class="token keyword">function</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
		<span class="token keyword">return</span> config
	<span class="token punctuation">}</span>
	<span class="token punctuation">{</span>
		configDef<span class="token punctuation">.</span><span class="token function-variable function">set</span> <span class="token operator">=</span> <span class="token keyword">function</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
			<span class="token function">warn</span><span class="token punctuation">(</span><span class="token string">'Do not replace the Vue.config object, set individual fields instead.'</span><span class="token punctuation">)</span>
		<span class="token punctuation">}</span>
	<span class="token punctuation">}</span>
	<span class="token comment">// 通过Vue.config拿到配置信息</span>
	Object<span class="token punctuation">.</span><span class="token function">defineProperty</span><span class="token punctuation">(</span>Vue<span class="token punctuation">,</span> <span class="token string">'config'</span><span class="token punctuation">,</span> configDef<span class="token punctuation">)</span>

	<span class="token comment">// 工具类不作为公共暴露的API使用</span>
	Vue<span class="token punctuation">.</span>util <span class="token operator">=</span> <span class="token punctuation">{</span>
		warn<span class="token operator">:</span> warn<span class="token punctuation">,</span>
		extend<span class="token operator">:</span> extend<span class="token punctuation">,</span>
		mergeOptions<span class="token operator">:</span> mergeOptions<span class="token punctuation">,</span>
		defineReactive<span class="token operator">:</span> defineReactive<span class="token punctuation">,</span>
	<span class="token punctuation">}</span>

	<span class="token comment">// Vue.set = Vue.prototype.$set</span>
	Vue<span class="token punctuation">.</span>set <span class="token operator">=</span> <span class="token keyword">set</span>
	<span class="token comment">// Vue.delete = Vue.prototype.$delete</span>
	Vue<span class="token punctuation">.</span>delete <span class="token operator">=</span> del
	<span class="token comment">// Vue.nextTick = Vue.prototype.$nextTick</span>
	Vue<span class="token punctuation">.</span>nextTick <span class="token operator">=</span> nextTick

	<span class="token comment">// 2.6 explicit observable API</span>
	Vue<span class="token punctuation">.</span><span class="token function-variable function">observable</span> <span class="token operator">=</span> <span class="token keyword">function</span><span class="token punctuation">(</span><span class="token parameter">obj</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
		<span class="token function">observe</span><span class="token punctuation">(</span>obj<span class="token punctuation">)</span>
		<span class="token keyword">return</span> obj
	<span class="token punctuation">}</span>

	<span class="token comment">// 构造函数的默认选项默认为components,directive,filter, _base</span>
	Vue<span class="token punctuation">.</span>options <span class="token operator">=</span> Object<span class="token punctuation">.</span><span class="token function">create</span><span class="token punctuation">(</span><span class="token keyword">null</span><span class="token punctuation">)</span>
	<span class="token constant">ASSET_TYPES</span><span class="token punctuation">.</span><span class="token function">forEach</span><span class="token punctuation">(</span><span class="token keyword">function</span><span class="token punctuation">(</span><span class="token parameter">type</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
		Vue<span class="token punctuation">.</span>options<span class="token punctuation">[</span>type <span class="token operator">+</span> <span class="token string">'s'</span><span class="token punctuation">]</span> <span class="token operator">=</span> Object<span class="token punctuation">.</span><span class="token function">create</span><span class="token punctuation">(</span><span class="token keyword">null</span><span class="token punctuation">)</span>
	<span class="token punctuation">}</span><span class="token punctuation">)</span>

	<span class="token comment">// options里的_base属性存储Vue构造器</span>
	Vue<span class="token punctuation">.</span>options<span class="token punctuation">.</span>_base <span class="token operator">=</span> Vue
	<span class="token function">extend</span><span class="token punctuation">(</span>Vue<span class="token punctuation">.</span>options<span class="token punctuation">.</span>components<span class="token punctuation">,</span> builtInComponents<span class="token punctuation">)</span>
	<span class="token comment">// Vue.use()</span>
	<span class="token function">initUse</span><span class="token punctuation">(</span>Vue<span class="token punctuation">)</span>
	<span class="token comment">// Vue.mixin()</span>
	<span class="token function">initMixin$1</span><span class="token punctuation">(</span>Vue<span class="token punctuation">)</span>
	<span class="token comment">// 定义extend扩展子类构造器的方法</span>
	<span class="token comment">// Vue.extend()</span>
	<span class="token function">initExtend</span><span class="token punctuation">(</span>Vue<span class="token punctuation">)</span>
	<span class="token comment">// Vue.components, Vue.directive, Vue.filter</span>
	<span class="token function">initAssetRegisters</span><span class="token punctuation">(</span>Vue<span class="token punctuation">)</span>
<span class="token punctuation">}</span>
</code></pre></div><p>看着源码对静态方法的定义做一个汇总。</p> <ol><li>为源码里的<code>config</code>配置做一层代理，可以通过<code>Vue.config</code>拿到默认的配置，并且可以修改它的属性值，具体哪些可以配置修改，可以先参照官方文档。</li> <li>定义内部使用的工具方法，例如警告提示，对象合并等。</li> <li>定义<code>set,delet,nextTick</code>方法，本质上原型上也有这些方法的定义。</li> <li>对<code>Vue.components,Vue.directive,Vue.filter</code>的定义，这些是默认的资源选项，后续会重点分析。</li> <li>定义<code>Vue.use()</code>方法</li> <li>定义<code>Vue.mixin()</code>方法</li> <li>定义<code>Vue.extend()</code>方法</li></ol> <h3 id="构造器的默认选项"><a href="#构造器的默认选项" class="header-anchor">#</a> 构造器的默认选项</h3> <p>回到最开始的例子，在实例化<code>Vue</code>时，我们会将选项对象传递给构造器进行初始化，这个选项对象描述了你想要的行为，例如以<code>data</code>定义实例中的响应式数据，以<code>computed</code>描述实例中的计算属性，以<code>components</code>来进行组件注册，甚至是定义各个阶段执行的生命周期钩子等。然而<code>Vue</code>内部本身会自带一些默认的选项，这些选项和用户自定义的选项会在后续一起参与到<code>Vue</code>实例的初始化中。</p> <p>在<code>initGlobalAPI</code>方法中有几行默认选项的定义。<code>Vue</code>内部的默认选项会保留在静态的<code>options</code>属性上，从源码看<code>Vue</code>自身有四个默认配置选项，分别是<code>component，directive， filter</code>以及返回自身构造器的<code>_base</code>。</p> <div class="language-js extra-class"><pre class="language-js"><code><span class="token keyword">var</span> <span class="token constant">ASSET_TYPES</span> <span class="token operator">=</span> <span class="token punctuation">[</span><span class="token string">'component'</span><span class="token punctuation">,</span> <span class="token string">'directive'</span><span class="token punctuation">,</span> <span class="token string">'filter'</span><span class="token punctuation">]</span>
<span class="token comment">// 原型上创建了一个指向为空对象的options属性</span>
Vue<span class="token punctuation">.</span>options <span class="token operator">=</span> Object<span class="token punctuation">.</span><span class="token function">create</span><span class="token punctuation">(</span><span class="token keyword">null</span><span class="token punctuation">)</span>
<span class="token constant">ASSET_TYPES</span><span class="token punctuation">.</span><span class="token function">forEach</span><span class="token punctuation">(</span><span class="token keyword">function</span><span class="token punctuation">(</span><span class="token parameter">type</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
	Vue<span class="token punctuation">.</span>options<span class="token punctuation">[</span>type <span class="token operator">+</span> <span class="token string">'s'</span><span class="token punctuation">]</span> <span class="token operator">=</span> Object<span class="token punctuation">.</span><span class="token function">create</span><span class="token punctuation">(</span><span class="token keyword">null</span><span class="token punctuation">)</span>
<span class="token punctuation">}</span><span class="token punctuation">)</span>
Vue<span class="token punctuation">.</span>options<span class="token punctuation">.</span>_base <span class="token operator">=</span> Vue
</code></pre></div><p>很明显我们开发者对这几个选项是非常熟悉的，<code>components</code>是需要注册的组件选项，<code>directives</code>是需要注册的指令，而<code>filter</code>则代表需要注册的过滤器。从代码的实现细节看，<code>Vue</code>为<code>components</code>提供了<code>keepAlive,transition,transitionGroup</code>的内置组件，为<code>directives</code>提供了<code>v-model,v-show</code>的内置指令，而过滤器则没有默认值。</p> <div class="language-js extra-class"><pre class="language-js"><code><span class="token comment">// Vue内置组件</span>
<span class="token keyword">var</span> builtInComponents <span class="token operator">=</span> <span class="token punctuation">{</span>
	KeepAlive<span class="token operator">:</span> KeepAlive<span class="token punctuation">,</span>
<span class="token punctuation">}</span>
<span class="token keyword">var</span> platformComponents <span class="token operator">=</span> <span class="token punctuation">{</span>
	Transition<span class="token operator">:</span> Transition<span class="token punctuation">,</span>
	TransitionGroup<span class="token operator">:</span> TransitionGroup<span class="token punctuation">,</span>
<span class="token punctuation">}</span>
<span class="token comment">// Vue 内置指令，例如： v-model, v-show</span>
<span class="token keyword">var</span> platformDirectives <span class="token operator">=</span> <span class="token punctuation">{</span>
	model<span class="token operator">:</span> directive<span class="token punctuation">,</span>
	show<span class="token operator">:</span> show<span class="token punctuation">,</span>
<span class="token punctuation">}</span>
<span class="token function">extend</span><span class="token punctuation">(</span>Vue<span class="token punctuation">.</span>options<span class="token punctuation">.</span>components<span class="token punctuation">,</span> builtInComponents<span class="token punctuation">)</span>
<span class="token function">extend</span><span class="token punctuation">(</span>Vue<span class="token punctuation">.</span>options<span class="token punctuation">.</span>components<span class="token punctuation">,</span> platformComponents<span class="token punctuation">)</span> <span class="token comment">// 扩展内置组件</span>
<span class="token function">extend</span><span class="token punctuation">(</span>Vue<span class="token punctuation">.</span>options<span class="token punctuation">.</span>directives<span class="token punctuation">,</span> platformDirectives<span class="token punctuation">)</span> <span class="token comment">// 扩展内置指令</span>
</code></pre></div><p>其中<code>extend</code>方法实现了对象的合并，如果属性相同，则用新的属性值覆盖旧值。</p> <div class="language-js extra-class"><pre class="language-js"><code><span class="token comment">// 将_from对象合并到to对象，属性相同时，则覆盖to对象的属性</span>
<span class="token keyword">function</span> <span class="token function">extend</span><span class="token punctuation">(</span><span class="token parameter">to<span class="token punctuation">,</span> _from</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
	<span class="token keyword">for</span> <span class="token punctuation">(</span><span class="token keyword">var</span> key <span class="token keyword">in</span> _from<span class="token punctuation">)</span> <span class="token punctuation">{</span>
		to<span class="token punctuation">[</span>key<span class="token punctuation">]</span> <span class="token operator">=</span> _from<span class="token punctuation">[</span>key<span class="token punctuation">]</span>
	<span class="token punctuation">}</span>
	<span class="token keyword">return</span> to
<span class="token punctuation">}</span>
</code></pre></div><p>因此做为构造器而言，<code>Vue</code>默认的资源选项配置如下：</p> <div class="language-js extra-class"><pre class="language-js"><code>Vue<span class="token punctuation">.</span>options <span class="token operator">=</span> <span class="token punctuation">{</span>
  components<span class="token operator">:</span> <span class="token punctuation">{</span>
    KeepAlive<span class="token operator">:</span> <span class="token punctuation">{</span><span class="token punctuation">}</span>
    Transition<span class="token operator">:</span> <span class="token punctuation">{</span><span class="token punctuation">}</span>
    TransitionGroup<span class="token operator">:</span> <span class="token punctuation">{</span><span class="token punctuation">}</span>
  <span class="token punctuation">}</span><span class="token punctuation">,</span>
  directives<span class="token operator">:</span> <span class="token punctuation">{</span>
    model<span class="token operator">:</span> <span class="token punctuation">{</span>inserted<span class="token operator">:</span> ƒ<span class="token punctuation">,</span> componentUpdated<span class="token operator">:</span> ƒ<span class="token punctuation">}</span>
    show<span class="token operator">:</span> <span class="token punctuation">{</span>bind<span class="token operator">:</span> ƒ<span class="token punctuation">,</span> update<span class="token operator">:</span> ƒ<span class="token punctuation">,</span> unbind<span class="token operator">:</span> ƒ<span class="token punctuation">}</span>
  <span class="token punctuation">}</span><span class="token punctuation">,</span>
  filters<span class="token operator">:</span> <span class="token punctuation">{</span><span class="token punctuation">}</span>
  _base
<span class="token punctuation">}</span>
</code></pre></div><h3 id="选项检验"><a href="#选项检验" class="header-anchor">#</a> 选项检验</h3> <p>介绍完<code>Vue</code>自身拥有的选项后，我们回过头来看看，实例化<code>Vue</code>的阶段发生了什么。从构造器的定义我们很容易发现，实例化<code>Vue</code>做的核心操作便是执行<code>_init</code>方法进行初始化。初始化操作会经过选项合并配置，初始化生命周期，初始化事件中心，乃至构建数据响应式系统等。而关键的第一步就是对选项的合并。合并后的选项会挂载到实例的<code>$options</code>属性中。(你可以先在实例中通过<code>this.$options</code>访问最终的选项)</p> <div class="language-js extra-class"><pre class="language-js"><code><span class="token keyword">function</span> <span class="token function">initMixin</span><span class="token punctuation">(</span><span class="token parameter">Vue</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
	<span class="token class-name">Vue</span><span class="token punctuation">.</span>prototype<span class="token punctuation">.</span><span class="token function-variable function">_init</span> <span class="token operator">=</span> <span class="token keyword">function</span><span class="token punctuation">(</span><span class="token parameter">options</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
		<span class="token keyword">var</span> vm <span class="token operator">=</span> <span class="token keyword">this</span>
		<span class="token comment">// a uid</span>
		<span class="token comment">// 记录实例化多少个vue对象</span>
		vm<span class="token punctuation">.</span>_uid <span class="token operator">=</span> uid$<span class="token number">3</span><span class="token operator">++</span>

		<span class="token comment">// 选项合并，将合并后的选项赋值给实例的$options属性</span>
		vm<span class="token punctuation">.</span>$options <span class="token operator">=</span> <span class="token function">mergeOptions</span><span class="token punctuation">(</span>
			<span class="token function">resolveConstructorOptions</span><span class="token punctuation">(</span>vm<span class="token punctuation">.</span>constructor<span class="token punctuation">)</span><span class="token punctuation">,</span> <span class="token comment">// 返回Vue构造函数自身的配置项</span>
			options <span class="token operator">||</span> <span class="token punctuation">{</span><span class="token punctuation">}</span><span class="token punctuation">,</span>
			vm
		<span class="token punctuation">)</span>
	<span class="token punctuation">}</span>
<span class="token punctuation">}</span>
</code></pre></div><p>从代码中可以看到，选项合并的重点是将用户自身传递的<code>options</code>选项和<code>Vue</code>构造函数自身的选项配置合并。我们看看<code>mergeOptions</code>函数的实现。</p> <div class="language-js extra-class"><pre class="language-js"><code><span class="token keyword">function</span> <span class="token function">mergeOptions</span><span class="token punctuation">(</span><span class="token parameter">parent<span class="token punctuation">,</span> child<span class="token punctuation">,</span> vm</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
	<span class="token punctuation">{</span>
		<span class="token function">checkComponents</span><span class="token punctuation">(</span>child<span class="token punctuation">)</span>
	<span class="token punctuation">}</span>
	<span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token keyword">typeof</span> child <span class="token operator">===</span> <span class="token string">'function'</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
		child <span class="token operator">=</span> child<span class="token punctuation">.</span>options
	<span class="token punctuation">}</span>
	<span class="token comment">// props,inject,directives的校验和规范化</span>
	<span class="token function">normalizeProps</span><span class="token punctuation">(</span>child<span class="token punctuation">,</span> vm<span class="token punctuation">)</span>
	<span class="token function">normalizeInject</span><span class="token punctuation">(</span>child<span class="token punctuation">,</span> vm<span class="token punctuation">)</span>
	<span class="token function">normalizeDirectives</span><span class="token punctuation">(</span>child<span class="token punctuation">)</span>

	<span class="token comment">// 针对extends扩展的子类构造器</span>
	<span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token operator">!</span>child<span class="token punctuation">.</span>_base<span class="token punctuation">)</span> <span class="token punctuation">{</span>
		<span class="token comment">// extends</span>
		<span class="token keyword">if</span> <span class="token punctuation">(</span>child<span class="token punctuation">.</span>extends<span class="token punctuation">)</span> <span class="token punctuation">{</span>
			parent <span class="token operator">=</span> <span class="token function">mergeOptions</span><span class="token punctuation">(</span>parent<span class="token punctuation">,</span> child<span class="token punctuation">.</span>extends<span class="token punctuation">,</span> vm<span class="token punctuation">)</span>
		<span class="token punctuation">}</span>
		<span class="token comment">// mixins</span>
		<span class="token keyword">if</span> <span class="token punctuation">(</span>child<span class="token punctuation">.</span>mixins<span class="token punctuation">)</span> <span class="token punctuation">{</span>
			<span class="token keyword">for</span> <span class="token punctuation">(</span><span class="token keyword">var</span> i <span class="token operator">=</span> <span class="token number">0</span><span class="token punctuation">,</span> l <span class="token operator">=</span> child<span class="token punctuation">.</span>mixins<span class="token punctuation">.</span>length<span class="token punctuation">;</span> i <span class="token operator">&lt;</span> l<span class="token punctuation">;</span> i<span class="token operator">++</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
				parent <span class="token operator">=</span> <span class="token function">mergeOptions</span><span class="token punctuation">(</span>parent<span class="token punctuation">,</span> child<span class="token punctuation">.</span>mixins<span class="token punctuation">[</span>i<span class="token punctuation">]</span><span class="token punctuation">,</span> vm<span class="token punctuation">)</span>
			<span class="token punctuation">}</span>
		<span class="token punctuation">}</span>
	<span class="token punctuation">}</span>

	<span class="token keyword">var</span> options <span class="token operator">=</span> <span class="token punctuation">{</span><span class="token punctuation">}</span>
	<span class="token keyword">var</span> key
	<span class="token keyword">for</span> <span class="token punctuation">(</span>key <span class="token keyword">in</span> parent<span class="token punctuation">)</span> <span class="token punctuation">{</span>
		<span class="token function">mergeField</span><span class="token punctuation">(</span>key<span class="token punctuation">)</span>
	<span class="token punctuation">}</span>
	<span class="token keyword">for</span> <span class="token punctuation">(</span>key <span class="token keyword">in</span> child<span class="token punctuation">)</span> <span class="token punctuation">{</span>
		<span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token operator">!</span><span class="token function">hasOwn</span><span class="token punctuation">(</span>parent<span class="token punctuation">,</span> key<span class="token punctuation">)</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
			<span class="token function">mergeField</span><span class="token punctuation">(</span>key<span class="token punctuation">)</span>
		<span class="token punctuation">}</span>
	<span class="token punctuation">}</span>
	<span class="token keyword">function</span> <span class="token function">mergeField</span><span class="token punctuation">(</span><span class="token parameter">key</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
		<span class="token comment">// 拿到各个选择指定的选项配置，如果没有则用默认的配置</span>
		<span class="token keyword">var</span> strat <span class="token operator">=</span> strats<span class="token punctuation">[</span>key<span class="token punctuation">]</span> <span class="token operator">||</span> defaultStrat
		<span class="token comment">// 执行各自的合并策略</span>
		options<span class="token punctuation">[</span>key<span class="token punctuation">]</span> <span class="token operator">=</span> <span class="token function">strat</span><span class="token punctuation">(</span>parent<span class="token punctuation">[</span>key<span class="token punctuation">]</span><span class="token punctuation">,</span> child<span class="token punctuation">[</span>key<span class="token punctuation">]</span><span class="token punctuation">,</span> vm<span class="token punctuation">,</span> key<span class="token punctuation">)</span>
	<span class="token punctuation">}</span>
	<span class="token comment">// console.log(options)</span>
	<span class="token keyword">return</span> options
<span class="token punctuation">}</span>
</code></pre></div><p>**选项合并过程中更多的不可控在于不知道用户传递了哪些配置选项，这些配置是否符合规范，是否达到合并配置的要求。因此每个选项的书写规则需要严格限定，原则上不允许用户脱离规则外来传递选项。**因此在合并选项之前，很大的一部分工作是对选项的校验。其中<code>components,prop,inject,directive</code>等都是检验的重点。</p> <h4 id="components-规范检验"><a href="#components-规范检验" class="header-anchor">#</a> components 规范检验</h4> <p>如果项目中需要使用到组件，我们会在<code>vue</code>实例化时传入组件选项以此来注册组件。因此，组件命名需要遵守很多规范，比如组件名不能用<code>html</code>保留的标签(如：<code>img,p</code>),也不能包含非法的字符等。这些都会在<code>validateComponentName</code>函数做校验。</p> <div class="language-js extra-class"><pre class="language-js"><code><span class="token comment">// components规范检查函数</span>
<span class="token keyword">function</span> <span class="token function">checkComponents</span><span class="token punctuation">(</span><span class="token parameter">options</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
	<span class="token comment">// 遍历components对象，对每个属性值校验。</span>
	<span class="token keyword">for</span> <span class="token punctuation">(</span><span class="token keyword">var</span> key <span class="token keyword">in</span> options<span class="token punctuation">.</span>components<span class="token punctuation">)</span> <span class="token punctuation">{</span>
		<span class="token function">validateComponentName</span><span class="token punctuation">(</span>key<span class="token punctuation">)</span>
	<span class="token punctuation">}</span>
<span class="token punctuation">}</span>
<span class="token keyword">function</span> <span class="token function">validateComponentName</span><span class="token punctuation">(</span><span class="token parameter">name</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
	<span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token operator">!</span><span class="token keyword">new</span> <span class="token class-name">RegExp</span><span class="token punctuation">(</span><span class="token string">'^[a-zA-Z][\\-\\.0-9_'</span> <span class="token operator">+</span> unicodeRegExp<span class="token punctuation">.</span>source <span class="token operator">+</span> <span class="token string">']*$'</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">test</span><span class="token punctuation">(</span>name<span class="token punctuation">)</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
		<span class="token comment">// 正则判断检测是否为非法的标签，例如数字开头</span>
		<span class="token function">warn</span><span class="token punctuation">(</span>
			<span class="token string">'Invalid component name: &quot;'</span> <span class="token operator">+</span>
				name <span class="token operator">+</span>
				<span class="token string">'&quot;. Component names '</span> <span class="token operator">+</span>
				<span class="token string">'should conform to valid custom element name in html5 specification.'</span>
		<span class="token punctuation">)</span>
	<span class="token punctuation">}</span>
	<span class="token comment">// 不能使用Vue自身自定义的组件名，如slot, component,不能使用html的保留标签，如 h1, svg等</span>
	<span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token function">isBuiltInTag</span><span class="token punctuation">(</span>name<span class="token punctuation">)</span> <span class="token operator">||</span> config<span class="token punctuation">.</span><span class="token function">isReservedTag</span><span class="token punctuation">(</span>name<span class="token punctuation">)</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
		<span class="token function">warn</span><span class="token punctuation">(</span><span class="token string">'Do not use built-in or reserved HTML elements as component '</span> <span class="token operator">+</span> <span class="token string">'id: '</span> <span class="token operator">+</span> name<span class="token punctuation">)</span>
	<span class="token punctuation">}</span>
<span class="token punctuation">}</span>
</code></pre></div><h4 id="props-规范检验"><a href="#props-规范检验" class="header-anchor">#</a> props 规范检验</h4> <p><code>Vue</code>的官方文档规定了<code>props</code>选项的书写形式有两种，分别是</p> <ol><li>数组形式 <code>{ props: ['a', 'b', 'c'] }</code>,</li> <li>带校验规则的对象形式 <code>{ props: { a: { type: 'String', default: 'prop校验' } }}</code> 从源码上看，<strong>两种形式最终都会转换成对象的形式。</strong></li></ol> <div class="language-js extra-class"><pre class="language-js"><code><span class="token comment">// props规范校验</span>
<span class="token keyword">function</span> <span class="token function">normalizeProps</span><span class="token punctuation">(</span><span class="token parameter">options<span class="token punctuation">,</span> vm</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
	<span class="token keyword">var</span> props <span class="token operator">=</span> options<span class="token punctuation">.</span>props
	<span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token operator">!</span>props<span class="token punctuation">)</span> <span class="token punctuation">{</span>
		<span class="token keyword">return</span>
	<span class="token punctuation">}</span>
	<span class="token keyword">var</span> res <span class="token operator">=</span> <span class="token punctuation">{</span><span class="token punctuation">}</span>
	<span class="token keyword">var</span> i<span class="token punctuation">,</span> val<span class="token punctuation">,</span> name
	<span class="token comment">// props选项数据有两种形式，一种是['a', 'b', 'c'],一种是{ a: { type: 'String', default: 'hahah' }}</span>
	<span class="token comment">// 数组</span>
	<span class="token keyword">if</span> <span class="token punctuation">(</span>Array<span class="token punctuation">.</span><span class="token function">isArray</span><span class="token punctuation">(</span>props<span class="token punctuation">)</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
		i <span class="token operator">=</span> props<span class="token punctuation">.</span>length
		<span class="token keyword">while</span> <span class="token punctuation">(</span>i<span class="token operator">--</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
			val <span class="token operator">=</span> props<span class="token punctuation">[</span>i<span class="token punctuation">]</span>
			<span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token keyword">typeof</span> val <span class="token operator">===</span> <span class="token string">'string'</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
				name <span class="token operator">=</span> <span class="token function">camelize</span><span class="token punctuation">(</span>val<span class="token punctuation">)</span>
				<span class="token comment">// 默认将数组形式的props转换为对象形式。</span>
				res<span class="token punctuation">[</span>name<span class="token punctuation">]</span> <span class="token operator">=</span> <span class="token punctuation">{</span> type<span class="token operator">:</span> <span class="token keyword">null</span> <span class="token punctuation">}</span>
			<span class="token punctuation">}</span> <span class="token keyword">else</span> <span class="token punctuation">{</span>
				<span class="token comment">// 规则：保证是字符串</span>
				<span class="token function">warn</span><span class="token punctuation">(</span><span class="token string">'props must be strings when using array syntax.'</span><span class="token punctuation">)</span>
			<span class="token punctuation">}</span>
		<span class="token punctuation">}</span>
	<span class="token punctuation">}</span> <span class="token keyword">else</span> <span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token function">isPlainObject</span><span class="token punctuation">(</span>props<span class="token punctuation">)</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
		<span class="token keyword">for</span> <span class="token punctuation">(</span><span class="token keyword">var</span> key <span class="token keyword">in</span> props<span class="token punctuation">)</span> <span class="token punctuation">{</span>
			val <span class="token operator">=</span> props<span class="token punctuation">[</span>key<span class="token punctuation">]</span>
			name <span class="token operator">=</span> <span class="token function">camelize</span><span class="token punctuation">(</span>key<span class="token punctuation">)</span>
			res<span class="token punctuation">[</span>name<span class="token punctuation">]</span> <span class="token operator">=</span> <span class="token function">isPlainObject</span><span class="token punctuation">(</span>val<span class="token punctuation">)</span> <span class="token operator">?</span> val <span class="token operator">:</span> <span class="token punctuation">{</span> type<span class="token operator">:</span> val <span class="token punctuation">}</span>
		<span class="token punctuation">}</span>
	<span class="token punctuation">}</span> <span class="token keyword">else</span> <span class="token punctuation">{</span>
		<span class="token comment">// 非数组，非对象则判定props选项传递非法</span>
		<span class="token function">warn</span><span class="token punctuation">(</span><span class="token string">'Invalid value for option &quot;props&quot;: expected an Array or an Object, '</span> <span class="token operator">+</span> <span class="token string">'but got '</span> <span class="token operator">+</span> <span class="token function">toRawType</span><span class="token punctuation">(</span>props<span class="token punctuation">)</span> <span class="token operator">+</span> <span class="token string">'.'</span><span class="token punctuation">,</span> vm<span class="token punctuation">)</span>
	<span class="token punctuation">}</span>
	options<span class="token punctuation">.</span>props <span class="token operator">=</span> res
<span class="token punctuation">}</span>
</code></pre></div><h4 id="inject-的规范校验"><a href="#inject-的规范校验" class="header-anchor">#</a> inject 的规范校验</h4> <p><code>provide/inject</code>这对组合在我们日常开发中可能使用得比较少，当我们需要在父组件中提供数据或者方法给后代组件使用时可以用到<code>provide/inject</code>,注意关键是后代，而不单纯指子代，这是有别于<code>props</code>的使用场景。官方把它被称为依赖注入，依赖注入使得组件后代都能访问到父代注入的数据/方法，且后代不需要知道数据的来源。重要的一点，依赖提供的数据是非响应式的。</p> <p>基本的使用如下：</p> <div class="language-js extra-class"><pre class="language-js"><code><span class="token comment">// 父组件</span>
<span class="token keyword">var</span> Provider <span class="token operator">=</span> <span class="token punctuation">{</span>
	provide<span class="token operator">:</span> <span class="token punctuation">{</span>
		foo<span class="token operator">:</span> <span class="token string">'bar'</span><span class="token punctuation">,</span>
	<span class="token punctuation">}</span><span class="token punctuation">,</span>
	<span class="token comment">// ...</span>
<span class="token punctuation">}</span>
<span class="token comment">// 后代组件</span>
<span class="token keyword">var</span> Child <span class="token operator">=</span> <span class="token punctuation">{</span>
	<span class="token comment">// 数组写法</span>
	inject<span class="token operator">:</span> <span class="token punctuation">[</span><span class="token string">'foo'</span><span class="token punctuation">]</span><span class="token punctuation">,</span>
	<span class="token comment">// 对象写法</span>
	inject<span class="token operator">:</span> <span class="token punctuation">{</span>
		foo<span class="token operator">:</span> <span class="token punctuation">{</span>
			from<span class="token operator">:</span> <span class="token string">'foo'</span><span class="token punctuation">,</span>
			<span class="token keyword">default</span><span class="token operator">:</span> <span class="token string">'bardefault'</span><span class="token punctuation">,</span>
		<span class="token punctuation">}</span><span class="token punctuation">,</span>
	<span class="token punctuation">}</span><span class="token punctuation">,</span>
<span class="token punctuation">}</span>
</code></pre></div><p><code>inject</code>选项有两种写法，数组的方式以及对象的方式，和<code>props</code>的校验规则一致，最终<code>inject</code>都会转换为对象的形式存在。</p> <div class="language-js extra-class"><pre class="language-js"><code><span class="token comment">// inject的规范化</span>
<span class="token keyword">function</span> <span class="token function">normalizeInject</span><span class="token punctuation">(</span><span class="token parameter">options<span class="token punctuation">,</span> vm</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
	<span class="token keyword">var</span> inject <span class="token operator">=</span> options<span class="token punctuation">.</span>inject
	<span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token operator">!</span>inject<span class="token punctuation">)</span> <span class="token punctuation">{</span>
		<span class="token keyword">return</span>
	<span class="token punctuation">}</span>
	<span class="token keyword">var</span> normalized <span class="token operator">=</span> <span class="token punctuation">(</span>options<span class="token punctuation">.</span>inject <span class="token operator">=</span> <span class="token punctuation">{</span><span class="token punctuation">}</span><span class="token punctuation">)</span>
	<span class="token comment">//数组的形式</span>
	<span class="token keyword">if</span> <span class="token punctuation">(</span>Array<span class="token punctuation">.</span><span class="token function">isArray</span><span class="token punctuation">(</span>inject<span class="token punctuation">)</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
		<span class="token keyword">for</span> <span class="token punctuation">(</span><span class="token keyword">var</span> i <span class="token operator">=</span> <span class="token number">0</span><span class="token punctuation">;</span> i <span class="token operator">&lt;</span> inject<span class="token punctuation">.</span>length<span class="token punctuation">;</span> i<span class="token operator">++</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
			<span class="token comment">// from: 属性是在可用的注入内容中搜索用的 key (字符串或 Symbol)</span>
			normalized<span class="token punctuation">[</span>inject<span class="token punctuation">[</span>i<span class="token punctuation">]</span><span class="token punctuation">]</span> <span class="token operator">=</span> <span class="token punctuation">{</span> from<span class="token operator">:</span> inject<span class="token punctuation">[</span>i<span class="token punctuation">]</span> <span class="token punctuation">}</span>
		<span class="token punctuation">}</span>
	<span class="token punctuation">}</span> <span class="token keyword">else</span> <span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token function">isPlainObject</span><span class="token punctuation">(</span>inject<span class="token punctuation">)</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
		<span class="token comment">// 对象的处理</span>
		<span class="token keyword">for</span> <span class="token punctuation">(</span><span class="token keyword">var</span> key <span class="token keyword">in</span> inject<span class="token punctuation">)</span> <span class="token punctuation">{</span>
			<span class="token keyword">var</span> val <span class="token operator">=</span> inject<span class="token punctuation">[</span>key<span class="token punctuation">]</span>
			normalized<span class="token punctuation">[</span>key<span class="token punctuation">]</span> <span class="token operator">=</span> <span class="token function">isPlainObject</span><span class="token punctuation">(</span>val<span class="token punctuation">)</span> <span class="token operator">?</span> <span class="token function">extend</span><span class="token punctuation">(</span><span class="token punctuation">{</span> from<span class="token operator">:</span> key <span class="token punctuation">}</span><span class="token punctuation">,</span> val<span class="token punctuation">)</span> <span class="token operator">:</span> <span class="token punctuation">{</span> from<span class="token operator">:</span> val <span class="token punctuation">}</span>
		<span class="token punctuation">}</span>
	<span class="token punctuation">}</span> <span class="token keyword">else</span> <span class="token punctuation">{</span>
		<span class="token comment">// 非法规则</span>
		<span class="token function">warn</span><span class="token punctuation">(</span>
			<span class="token string">'Invalid value for option &quot;inject&quot;: expected an Array or an Object, '</span> <span class="token operator">+</span> <span class="token string">'but got '</span> <span class="token operator">+</span> <span class="token function">toRawType</span><span class="token punctuation">(</span>inject<span class="token punctuation">)</span> <span class="token operator">+</span> <span class="token string">'.'</span><span class="token punctuation">,</span>
			vm
		<span class="token punctuation">)</span>
	<span class="token punctuation">}</span>
<span class="token punctuation">}</span>
</code></pre></div><h4 id="directive-的规范校验"><a href="#directive-的规范校验" class="header-anchor">#</a> directive 的规范校验</h4> <p>我们先看看指令选项的用法，<code>Vue</code>允许我们自定义指令，并且它提供了五个钩子函数<code>bind, inserted, update, componentUpdated, unbind</code>,具体的用法可以参考<a href="https://cn.vuejs.org/v2/guide/custom-directive.html" target="_blank" rel="noopener noreferrer">官方-自定义指令<span><svg xmlns="http://www.w3.org/2000/svg" aria-hidden="true" focusable="false" x="0px" y="0px" viewBox="0 0 100 100" width="15" height="15" class="icon outbound"><path fill="currentColor" d="M18.8,85.1h56l0,0c2.2,0,4-1.8,4-4v-32h-8v28h-48v-48h28v-8h-32l0,0c-2.2,0-4,1.8-4,4v56C14.8,83.3,16.6,85.1,18.8,85.1z"></path> <polygon fill="currentColor" points="45.7,48.7 51.3,54.3 77.2,28.5 77.2,37.2 85.2,37.2 85.2,14.9 62.8,14.9 62.8,22.9 71.5,22.9"></polygon></svg> <span class="sr-only">(opens new window)</span></span></a>文档,而除了可以以对象的形式去定义钩子函数外，官方还提供了一种函数的简写，例如：</p> <div class="language-js extra-class"><pre class="language-js"><code><span class="token punctuation">{</span>
  directives<span class="token operator">:</span> <span class="token punctuation">{</span>
    <span class="token string">'color-swatch'</span><span class="token operator">:</span> <span class="token keyword">function</span><span class="token punctuation">(</span><span class="token parameter">el<span class="token punctuation">,</span> binding</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
        el<span class="token punctuation">.</span>style<span class="token punctuation">.</span>backgroundColor <span class="token operator">=</span> binding<span class="token punctuation">.</span>value
    <span class="token punctuation">}</span>
  <span class="token punctuation">}</span>
<span class="token punctuation">}</span>
</code></pre></div><p>函数的写法会在<code>bind,update</code>钩子中触发相同的行为，并且不关心其他钩子。这个行为就是定义的函数。因此在对<code>directives</code>进行规范化时，针对函数的写法会将行为赋予<code>bind,update</code>钩子。</p> <div class="language-js extra-class"><pre class="language-js"><code><span class="token keyword">function</span> <span class="token function">normalizeDirectives</span><span class="token punctuation">(</span><span class="token parameter">options</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
	<span class="token keyword">var</span> dirs <span class="token operator">=</span> options<span class="token punctuation">.</span>directives
	<span class="token keyword">if</span> <span class="token punctuation">(</span>dirs<span class="token punctuation">)</span> <span class="token punctuation">{</span>
		<span class="token keyword">for</span> <span class="token punctuation">(</span><span class="token keyword">var</span> key <span class="token keyword">in</span> dirs<span class="token punctuation">)</span> <span class="token punctuation">{</span>
			<span class="token keyword">var</span> def <span class="token operator">=</span> dirs<span class="token punctuation">[</span>key<span class="token punctuation">]</span>
			<span class="token comment">// 函数简写同样会转换成对象的形式</span>
			<span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token keyword">typeof</span> def <span class="token operator">===</span> <span class="token string">'function'</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
				dirs<span class="token punctuation">[</span>key<span class="token punctuation">]</span> <span class="token operator">=</span> <span class="token punctuation">{</span> bind<span class="token operator">:</span> def<span class="token punctuation">,</span> update<span class="token operator">:</span> def <span class="token punctuation">}</span>
			<span class="token punctuation">}</span>
		<span class="token punctuation">}</span>
	<span class="token punctuation">}</span>
<span class="token punctuation">}</span>
</code></pre></div><h3 id="函数缓存"><a href="#函数缓存" class="header-anchor">#</a> 函数缓存</h3> <p>这个内容跟选项的规范化无关，当读到上面规范检测的代码时，发现有一段函数优化的代码值得我们学习。它将每次执行函数后的值进行缓存，当再次执行的时候直接调用缓存的数据而不是重复执行函数，以此提高前端性能，这是典型的用空间换时间的优化，也是经典的偏函数应用。</p> <div class="language-js extra-class"><pre class="language-js"><code><span class="token keyword">function</span> <span class="token function">cached</span> <span class="token punctuation">(</span><span class="token parameter">fn</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
  <span class="token keyword">var</span> cache <span class="token operator">=</span> Object<span class="token punctuation">.</span><span class="token function">create</span><span class="token punctuation">(</span><span class="token keyword">null</span><span class="token punctuation">)</span><span class="token punctuation">;</span> <span class="token comment">// 创建空对象作为缓存对象</span>
  <span class="token keyword">return</span> <span class="token punctuation">(</span><span class="token keyword">function</span> <span class="token function">cachedFn</span> <span class="token punctuation">(</span><span class="token parameter">str</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
    <span class="token keyword">var</span> hit <span class="token operator">=</span> cache<span class="token punctuation">[</span>str<span class="token punctuation">]</span><span class="token punctuation">;</span>
    <span class="token keyword">return</span> hit <span class="token operator">||</span> <span class="token punctuation">(</span>cache<span class="token punctuation">[</span>str<span class="token punctuation">]</span> <span class="token operator">=</span> <span class="token function">fn</span><span class="token punctuation">(</span>str<span class="token punctuation">)</span><span class="token punctuation">)</span> <span class="token comment">// 每次执行时缓存对象有值则不需要执行函数方法，没有则执行并缓存起来</span>
  <span class="token punctuation">}</span><span class="token punctuation">)</span>
<span class="token punctuation">}</span>

<span class="token keyword">var</span> camelizeRE <span class="token operator">=</span> <span class="token regex"><span class="token regex-delimiter">/</span><span class="token regex-source language-regex">-(\w)</span><span class="token regex-delimiter">/</span><span class="token regex-flags">g</span></span><span class="token punctuation">;</span>

<span class="token comment">// 缓存会保存每次进行驼峰转换的结果</span>
<span class="token keyword">var</span> camelize <span class="token operator">=</span> <span class="token function">cached</span><span class="token punctuation">(</span><span class="token keyword">function</span> <span class="token punctuation">(</span><span class="token parameter">str</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
  <span class="token comment">// 将诸如 'a-b'的写法统一处理成驼峰写法'aB'</span>
<span class="token keyword">return</span> str<span class="token punctuation">.</span><span class="token function">replace</span><span class="token punctuation">(</span>camelizeRE<span class="token punctuation">,</span> <span class="token keyword">function</span> <span class="token punctuation">(</span><span class="token parameter">_<span class="token punctuation">,</span> c</span><span class="token punctuation">)</span> <span class="token punctuation">{</span> <span class="token keyword">return</span> c <span class="token operator">?</span> c<span class="token punctuation">.</span><span class="token function">toUpperCase</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token operator">:</span> <span class="token string">''</span><span class="token punctuation">;</span> <span class="token punctuation">}</span><span class="token punctuation">)</span>
</code></pre></div><h3 id="子类构造器"><a href="#子类构造器" class="header-anchor">#</a> 子类构造器</h3> <p>选项校验介绍完后，在正式进入合并策略之前，还需要先了解一个东西：子类构造器。为什么需要先提到子类构造器呢？</p> <p>按照前面的知识，<code>Vue</code>内部提供了四个默认选项，关键的三个是<code>components,directives,filter</code>。那么当我们传递一个选项配置到<code>Vue</code>进行初始化，所需要合并的选项好像也仅仅是那关键的三个默认选项而已，那么源码中大篇幅做的选项合并策略又是针对什么场景呢？答案就是这个子类构造器。</p> <p><strong><code>Vue</code>提供了一个<code>Vue.extend</code>的静态方法，它是基于基础的<code>Vue</code>构造器创建一个“子类”，而这个子类所传递的选项配置会和父类的选项配置进行合并。这是选项合并场景的由来。</strong></p> <p>因此要先了解子类构造器的实现。下面例子中，我们创建了一个<code>Child</code>的子类，它继承于父类<code>Parent</code>,最终将子类挂载到<code>#app</code>元素上。最终获取的<code>data</code>便是选项合并后的结果。</p> <div class="language-js extra-class"><pre class="language-js"><code><span class="token keyword">var</span> Parent <span class="token operator">=</span> Vue<span class="token punctuation">.</span><span class="token function">extend</span><span class="token punctuation">(</span><span class="token punctuation">{</span>
  <span class="token function">data</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
    test<span class="token operator">:</span> <span class="token string">'父类'</span>，
    test1<span class="token operator">:</span> <span class="token string">'父类1'</span>
  <span class="token punctuation">}</span>
<span class="token punctuation">}</span><span class="token punctuation">)</span>
<span class="token keyword">var</span> Child <span class="token operator">=</span> Parent<span class="token punctuation">.</span><span class="token function">extend</span><span class="token punctuation">(</span><span class="token punctuation">{</span>
  <span class="token function">data</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
    test<span class="token operator">:</span> <span class="token string">'子类'</span><span class="token punctuation">,</span>
    test2<span class="token operator">:</span> <span class="token string">'子类1'</span>
  <span class="token punctuation">}</span>
<span class="token punctuation">}</span><span class="token punctuation">)</span>
<span class="token keyword">var</span> vm <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token class-name">Child</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">$mount</span><span class="token punctuation">(</span><span class="token string">'#app'</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
console<span class="token punctuation">.</span><span class="token function">log</span><span class="token punctuation">(</span>vm<span class="token punctuation">.</span>$data<span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token comment">// 结果</span>
<span class="token punctuation">{</span>
  test<span class="token operator">:</span> <span class="token string">'子类'</span><span class="token punctuation">,</span>
  test1<span class="token operator">:</span> <span class="token string">'父类1'</span><span class="token punctuation">,</span>
  test2<span class="token operator">:</span> <span class="token string">'子类1'</span>
<span class="token punctuation">}</span>
</code></pre></div><p><code>Vue.extend</code>的实现思路很清晰，创建了一个<code>Sub</code>的类，这个类的原型指向了父类，并且子类的<code>options</code>会和父类的<code>options</code>进行合并，<code>mergeOptions</code>的其他细节接下来会重点分析。</p> <div class="language-js extra-class"><pre class="language-js"><code>Vue<span class="token punctuation">.</span><span class="token function-variable function">extend</span> <span class="token operator">=</span> <span class="token keyword">function</span><span class="token punctuation">(</span><span class="token parameter">extendOptions</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
	extendOptions <span class="token operator">=</span> extendOptions <span class="token operator">||</span> <span class="token punctuation">{</span><span class="token punctuation">}</span>
	<span class="token keyword">var</span> Super <span class="token operator">=</span> <span class="token keyword">this</span>

	<span class="token keyword">var</span> name <span class="token operator">=</span> extendOptions<span class="token punctuation">.</span>name <span class="token operator">||</span> Super<span class="token punctuation">.</span>options<span class="token punctuation">.</span>name
	<span class="token keyword">if</span> <span class="token punctuation">(</span>name<span class="token punctuation">)</span> <span class="token punctuation">{</span>
		<span class="token function">validateComponentName</span><span class="token punctuation">(</span>name<span class="token punctuation">)</span> <span class="token comment">// 校验子类的名称是否符合规范</span>
	<span class="token punctuation">}</span>

	<span class="token comment">// 创建子类构造器</span>
	<span class="token keyword">var</span> <span class="token function-variable function">Sub</span> <span class="token operator">=</span> <span class="token keyword">function</span> <span class="token function">VueComponent</span><span class="token punctuation">(</span><span class="token parameter">options</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
		<span class="token keyword">this</span><span class="token punctuation">.</span><span class="token function">_init</span><span class="token punctuation">(</span>options<span class="token punctuation">)</span>
	<span class="token punctuation">}</span>
	<span class="token class-name">Sub</span><span class="token punctuation">.</span>prototype <span class="token operator">=</span> Object<span class="token punctuation">.</span><span class="token function">create</span><span class="token punctuation">(</span><span class="token class-name">Super</span><span class="token punctuation">.</span>prototype<span class="token punctuation">)</span> <span class="token comment">// 子类继承于父类</span>
	<span class="token class-name">Sub</span><span class="token punctuation">.</span>prototype<span class="token punctuation">.</span>constructor <span class="token operator">=</span> Sub
	Sub<span class="token punctuation">.</span>cid <span class="token operator">=</span> cid<span class="token operator">++</span>
	<span class="token comment">// 子类和父类构造器的配置选项进行合并</span>
	Sub<span class="token punctuation">.</span>options <span class="token operator">=</span> <span class="token function">mergeOptions</span><span class="token punctuation">(</span>Super<span class="token punctuation">.</span>options<span class="token punctuation">,</span> extendOptions<span class="token punctuation">)</span>

	<span class="token keyword">return</span> Sub <span class="token comment">// 返回子类构造函数</span>
<span class="token punctuation">}</span>
</code></pre></div><h3 id="合并策略"><a href="#合并策略" class="header-anchor">#</a> 合并策略</h3> <p>合并策略之所以是难点，其中一个是合并选项类型繁多，合并规则随着选项的不同也呈现差异。概括起来思路主要是以下两点：</p> <ol><li><code>Vue</code>针对每个规定的选项都有定义好的合并策略，例如<code>data,component,mounted</code>等。如果合并的子父配置都具有相同的选项，则只需要按照规定好的策略进行选项合并即可。</li> <li>由于<code>Vue</code>传递的选项是开放式的，所有也存在传递的选项没有自定义选项的情况，这时候由于选项不存在默认的合并策略，所以处理的原则是有子类配置选项则默认使用子类配置选项，没有则选择父类配置选项。</li></ol> <p>我们通过这两个思想去分析源码的实现，先看看<code>mergeOptions</code>除了规范检测后的逻辑。</p> <div class="language-js extra-class"><pre class="language-js"><code><span class="token keyword">function</span> <span class="token function">mergeOptions</span> <span class="token punctuation">(</span> <span class="token parameter">parent<span class="token punctuation">,</span> child<span class="token punctuation">,</span> vm</span> <span class="token punctuation">)</span> <span class="token punctuation">{</span>
  ···
  <span class="token keyword">var</span> options <span class="token operator">=</span> <span class="token punctuation">{</span><span class="token punctuation">}</span><span class="token punctuation">;</span>
  <span class="token keyword">var</span> key<span class="token punctuation">;</span>
  <span class="token keyword">for</span> <span class="token punctuation">(</span>key <span class="token keyword">in</span> parent<span class="token punctuation">)</span> <span class="token punctuation">{</span>
    <span class="token function">mergeField</span><span class="token punctuation">(</span>key<span class="token punctuation">)</span><span class="token punctuation">;</span>
  <span class="token punctuation">}</span>
  <span class="token keyword">for</span> <span class="token punctuation">(</span>key <span class="token keyword">in</span> child<span class="token punctuation">)</span> <span class="token punctuation">{</span>
    <span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token operator">!</span><span class="token function">hasOwn</span><span class="token punctuation">(</span>parent<span class="token punctuation">,</span> key<span class="token punctuation">)</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
      <span class="token function">mergeField</span><span class="token punctuation">(</span>key<span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token punctuation">}</span>
  <span class="token punctuation">}</span>
  <span class="token keyword">function</span> <span class="token function">mergeField</span> <span class="token punctuation">(</span><span class="token parameter">key</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
    <span class="token comment">// 如果有自定义选项策略，则使用自定义选项策略，否则选择使用默认策略。</span>
    <span class="token keyword">var</span> strat <span class="token operator">=</span> strats<span class="token punctuation">[</span>key<span class="token punctuation">]</span> <span class="token operator">||</span> defaultStrat<span class="token punctuation">;</span>
    options<span class="token punctuation">[</span>key<span class="token punctuation">]</span> <span class="token operator">=</span> <span class="token function">strat</span><span class="token punctuation">(</span>parent<span class="token punctuation">[</span>key<span class="token punctuation">]</span><span class="token punctuation">,</span> child<span class="token punctuation">[</span>key<span class="token punctuation">]</span><span class="token punctuation">,</span> vm<span class="token punctuation">,</span> key<span class="token punctuation">)</span><span class="token punctuation">;</span>
  <span class="token punctuation">}</span>

  <span class="token keyword">return</span> options
<span class="token punctuation">}</span>
</code></pre></div><p><strong>两个<code>for</code>循环规定了合并的顺序，以自定义选项策略优先，如果没有才会使用默认策略。而<code>strats</code>下每个<code>key</code>对应的便是每个特殊选项的合并策略</strong></p> <h4 id="默认策略"><a href="#默认策略" class="header-anchor">#</a> 默认策略</h4> <p>我们可以用丰富的选项去定义实例的行为，大致可以分为以下几类：</p> <ol><li>用<code>data,props,computed</code>等选项定义实例数据</li> <li>用<code>mounted, created, destoryed</code>等定义生命周期函数</li> <li>用<code>components</code>注册组件</li> <li>用<code>methods</code>选项定义实例方法</li></ol> <p>当然还有诸如<code>watch,inject,directives,filter</code>等选项，总而言之，<code>Vue</code>提供的配置项是丰富的。除此之外，我们也可以使用没有默认配置策略的选项，典型的例子是状态管理<code>Vuex</code>和配套路由<code>vue-router</code>的引入：</p> <div class="language-js extra-class"><pre class="language-js"><code><span class="token keyword">new</span> <span class="token class-name">Vue</span><span class="token punctuation">(</span><span class="token punctuation">{</span>
	store<span class="token punctuation">,</span> <span class="token comment">// vuex</span>
	router<span class="token punctuation">,</span> <span class="token comment">// vue-router</span>
<span class="token punctuation">}</span><span class="token punctuation">)</span>
</code></pre></div><p>不管是插件也好，还是用户自定义的选项，他们的合并策略会遵循思路的第二点：**子配置存在则取子配置，不存在则取父配置，即用子去覆盖父。。**它的描述在<code>defaultStrat</code>中。</p> <div class="language-js extra-class"><pre class="language-js"><code><span class="token comment">// 默认选项合并策略</span>
<span class="token keyword">var</span> <span class="token function-variable function">defaultStrat</span> <span class="token operator">=</span> <span class="token keyword">function</span><span class="token punctuation">(</span><span class="token parameter">parentVal<span class="token punctuation">,</span> childVal</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
	<span class="token comment">// 子不存在则用父，子存在则用子配置</span>
	<span class="token keyword">return</span> childVal <span class="token operator">===</span> <span class="token keyword">undefined</span> <span class="token operator">?</span> parentVal <span class="token operator">:</span> childVal
<span class="token punctuation">}</span>
</code></pre></div><p>接下来会进入某些具体的合并策略的分析，大致分为五类：</p> <p><strong>1. 常规选项合并</strong></p> <p><strong>2. 自带资源选项合并</strong></p> <p><strong>3. 生命周期钩子合并</strong></p> <p><strong>4. <code>watch</code>选项合并</strong></p> <p><strong>5. <code>props,methods, inject, computed</code>类似选项合并</strong></p> <h3 id="常规选项的合并"><a href="#常规选项的合并" class="header-anchor">#</a> 常规选项的合并</h3> <h4 id="el-的合并"><a href="#el-的合并" class="header-anchor">#</a> el 的合并</h4> <p><code>el</code>提供一个在页面上已存在的 <code>DOM</code> 元素作为 <code>Vue</code> 实例的挂载目标,因此它只在创建<code>Vue</code>实例才存在，在子类或者子组件中无法定义<code>el</code>选项，因此<code>el</code>的合并策略是在保证选项只存在于根的<code>Vue</code>实例的情形下使用默认策略进行合并。</p> <div class="language-js extra-class"><pre class="language-js"><code>strats<span class="token punctuation">.</span><span class="token function-variable function">el</span> <span class="token operator">=</span> <span class="token keyword">function</span><span class="token punctuation">(</span><span class="token parameter">parent<span class="token punctuation">,</span> child<span class="token punctuation">,</span> vm<span class="token punctuation">,</span> key</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
	<span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token operator">!</span>vm<span class="token punctuation">)</span> <span class="token punctuation">{</span>
		<span class="token comment">// 只允许vue实例才拥有el属性，其他子类构造器不允许有el属性</span>
		<span class="token function">warn</span><span class="token punctuation">(</span><span class="token string">'option &quot;'</span> <span class="token operator">+</span> key <span class="token operator">+</span> <span class="token string">'&quot; can only be used during instance '</span> <span class="token operator">+</span> <span class="token string">'creation with the `new` keyword.'</span><span class="token punctuation">)</span>
	<span class="token punctuation">}</span>
	<span class="token comment">// 默认策略</span>
	<span class="token keyword">return</span> <span class="token function">defaultStrat</span><span class="token punctuation">(</span>parent<span class="token punctuation">,</span> child<span class="token punctuation">)</span>
<span class="token punctuation">}</span>
Copy
</code></pre></div><h4 id="data-合并"><a href="#data-合并" class="header-anchor">#</a> data 合并</h4> <p>常规选项的重点部分是在于<code>data</code>的合并，读完这部分源码，可能可以解开你心中的一个疑惑，为什么<code>data</code>在<code>vue</code>创建实例时传递的是一个对象，而在组件内部定义时只能传递一个函数。</p> <div class="language-js extra-class"><pre class="language-js"><code><span class="token comment">// data的合并</span>
strats<span class="token punctuation">.</span><span class="token function-variable function">data</span> <span class="token operator">=</span> <span class="token keyword">function</span><span class="token punctuation">(</span><span class="token parameter">parentVal<span class="token punctuation">,</span> childVal<span class="token punctuation">,</span> vm</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
	<span class="token comment">// vm代表是否为Vue创建的实例，否则是子父类的关系</span>
	<span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token operator">!</span>vm<span class="token punctuation">)</span> <span class="token punctuation">{</span>
		<span class="token keyword">if</span> <span class="token punctuation">(</span>childVal <span class="token operator">&amp;&amp;</span> <span class="token keyword">typeof</span> childVal <span class="token operator">!==</span> <span class="token string">'function'</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
			<span class="token comment">// 必须保证子类的data类型是一个函数而不是一个对象</span>
			<span class="token function">warn</span><span class="token punctuation">(</span>
				<span class="token string">'The &quot;data&quot; option should be a function '</span> <span class="token operator">+</span> <span class="token string">'that returns a per-instance value in component '</span> <span class="token operator">+</span> <span class="token string">'definitions.'</span><span class="token punctuation">,</span>
				vm
			<span class="token punctuation">)</span>
			<span class="token keyword">return</span> parentVal
		<span class="token punctuation">}</span>
		<span class="token keyword">return</span> <span class="token function">mergeDataOrFn</span><span class="token punctuation">(</span>parentVal<span class="token punctuation">,</span> childVal<span class="token punctuation">)</span>
	<span class="token punctuation">}</span>
	<span class="token keyword">return</span> <span class="token function">mergeDataOrFn</span><span class="token punctuation">(</span>parentVal<span class="token punctuation">,</span> childVal<span class="token punctuation">,</span> vm<span class="token punctuation">)</span> <span class="token comment">// vue实例时需要传递vm作为函数的第三个参数</span>
<span class="token punctuation">}</span>
Copy
</code></pre></div><p><code>data</code>策略最终调用的<code>mergeDataOrFn</code>方法，区别在于当前<code>vm</code>是否是实例，或者是单纯的子父类的关系。如果是子父类的关系，需要对<code>data</code>选项进行规范校验，保证它的类型是一个函数而不是对象。</p> <div class="language-js extra-class"><pre class="language-js"><code><span class="token keyword">function</span> <span class="token function">mergeDataOrFn</span><span class="token punctuation">(</span><span class="token parameter">parentVal<span class="token punctuation">,</span> childVal<span class="token punctuation">,</span> vm</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
	<span class="token comment">// 子父类</span>
	<span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token operator">!</span>vm<span class="token punctuation">)</span> <span class="token punctuation">{</span>
		<span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token operator">!</span>childVal<span class="token punctuation">)</span> <span class="token punctuation">{</span>
			<span class="token comment">// 子类不存在data选项，则合并结果为父类data选项</span>
			<span class="token keyword">return</span> parentVal
		<span class="token punctuation">}</span>
		<span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token operator">!</span>parentVal<span class="token punctuation">)</span> <span class="token punctuation">{</span>
			<span class="token comment">// 父类不存在data选项，则合并结果为子类data选项</span>
			<span class="token keyword">return</span> childVal
		<span class="token punctuation">}</span>
		<span class="token keyword">return</span> <span class="token keyword">function</span> <span class="token function">mergedDataFn</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
			<span class="token comment">// data选项在父类和子类同时存在的情况下返回的是一个函数</span>
			<span class="token comment">// 子类实例和父类实例，分别将子类和父类实例中data函数执行后返回的对象传递给mergeData函数做数据合并</span>
			<span class="token keyword">return</span> <span class="token function">mergeData</span><span class="token punctuation">(</span>
				<span class="token keyword">typeof</span> childVal <span class="token operator">===</span> <span class="token string">'function'</span> <span class="token operator">?</span> <span class="token function">childVal</span><span class="token punctuation">.</span><span class="token function">call</span><span class="token punctuation">(</span><span class="token keyword">this</span><span class="token punctuation">,</span> <span class="token keyword">this</span><span class="token punctuation">)</span> <span class="token operator">:</span> childVal<span class="token punctuation">,</span>
				<span class="token keyword">typeof</span> parentVal <span class="token operator">===</span> <span class="token string">'function'</span> <span class="token operator">?</span> <span class="token function">parentVal</span><span class="token punctuation">.</span><span class="token function">call</span><span class="token punctuation">(</span><span class="token keyword">this</span><span class="token punctuation">,</span> <span class="token keyword">this</span><span class="token punctuation">)</span> <span class="token operator">:</span> parentVal
			<span class="token punctuation">)</span>
		<span class="token punctuation">}</span>
	<span class="token punctuation">}</span> <span class="token keyword">else</span> <span class="token punctuation">{</span>
		<span class="token comment">// Vue实例</span>
		<span class="token comment">// vue构造函数实例对象</span>
		<span class="token keyword">return</span> <span class="token keyword">function</span> <span class="token function">mergedInstanceDataFn</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
			<span class="token keyword">var</span> instanceData <span class="token operator">=</span> <span class="token keyword">typeof</span> childVal <span class="token operator">===</span> <span class="token string">'function'</span> <span class="token operator">?</span> <span class="token function">childVal</span><span class="token punctuation">.</span><span class="token function">call</span><span class="token punctuation">(</span>vm<span class="token punctuation">,</span> vm<span class="token punctuation">)</span> <span class="token operator">:</span> childVal
			<span class="token keyword">var</span> defaultData <span class="token operator">=</span> <span class="token keyword">typeof</span> parentVal <span class="token operator">===</span> <span class="token string">'function'</span> <span class="token operator">?</span> <span class="token function">parentVal</span><span class="token punctuation">.</span><span class="token function">call</span><span class="token punctuation">(</span>vm<span class="token punctuation">,</span> vm<span class="token punctuation">)</span> <span class="token operator">:</span> parentVal
			<span class="token keyword">if</span> <span class="token punctuation">(</span>instanceData<span class="token punctuation">)</span> <span class="token punctuation">{</span>
				<span class="token comment">// 当实例中传递data选项时，将实例的data对象和Vm构造函数上的data属性选项合并</span>
				<span class="token keyword">return</span> <span class="token function">mergeData</span><span class="token punctuation">(</span>instanceData<span class="token punctuation">,</span> defaultData<span class="token punctuation">)</span>
			<span class="token punctuation">}</span> <span class="token keyword">else</span> <span class="token punctuation">{</span>
				<span class="token comment">// 当实例中不传递data时，默认返回Vm构造函数上的data属性选项</span>
				<span class="token keyword">return</span> defaultData
			<span class="token punctuation">}</span>
		<span class="token punctuation">}</span>
	<span class="token punctuation">}</span>
<span class="token punctuation">}</span>
Copy
</code></pre></div><p>从源码的实现看，<code>data</code>的合并不是简单的将两个数据对象进行合并，而是直接返回一个<code>mergedDataFn</code>或者<code>mergedInstanceDataFn</code>函数，而真正合并的时机是在后续初始化数据响应式系统的环节进行的，初始化数据响应式系统的第一步就是拿到合并后的数据，也就是执行<code>mergeData</code>逻辑。 (关于响应式系统的构建请移步后面的章节)</p> <div class="language-js extra-class"><pre class="language-js"><code><span class="token keyword">function</span> <span class="token function">mergeData</span><span class="token punctuation">(</span><span class="token parameter">to<span class="token punctuation">,</span> <span class="token keyword">from</span></span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
	<span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token operator">!</span>from<span class="token punctuation">)</span> <span class="token punctuation">{</span>
		<span class="token keyword">return</span> to
	<span class="token punctuation">}</span>
	<span class="token keyword">var</span> key<span class="token punctuation">,</span> toVal<span class="token punctuation">,</span> fromVal
	<span class="token comment">// Reflect.ownKeys可以拿到Symbol属性</span>
	<span class="token keyword">var</span> keys <span class="token operator">=</span> hasSymbol <span class="token operator">?</span> Reflect<span class="token punctuation">.</span><span class="token function">ownKeys</span><span class="token punctuation">(</span>from<span class="token punctuation">)</span> <span class="token operator">:</span> Object<span class="token punctuation">.</span><span class="token function">keys</span><span class="token punctuation">(</span>from<span class="token punctuation">)</span>

	<span class="token keyword">for</span> <span class="token punctuation">(</span><span class="token keyword">var</span> i <span class="token operator">=</span> <span class="token number">0</span><span class="token punctuation">;</span> i <span class="token operator">&lt;</span> keys<span class="token punctuation">.</span>length<span class="token punctuation">;</span> i<span class="token operator">++</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
		key <span class="token operator">=</span> keys<span class="token punctuation">[</span>i<span class="token punctuation">]</span>
		toVal <span class="token operator">=</span> to<span class="token punctuation">[</span>key<span class="token punctuation">]</span>
		fromVal <span class="token operator">=</span> from<span class="token punctuation">[</span>key<span class="token punctuation">]</span>
		<span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token operator">!</span><span class="token function">hasOwn</span><span class="token punctuation">(</span>to<span class="token punctuation">,</span> key<span class="token punctuation">)</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
			<span class="token comment">// 子的数据父没有，则将新增的数据加入响应式系统中。</span>
			<span class="token function">set</span><span class="token punctuation">(</span>to<span class="token punctuation">,</span> key<span class="token punctuation">,</span> fromVal<span class="token punctuation">)</span>
		<span class="token punctuation">}</span> <span class="token keyword">else</span> <span class="token keyword">if</span> <span class="token punctuation">(</span>toVal <span class="token operator">!==</span> fromVal <span class="token operator">&amp;&amp;</span> <span class="token function">isPlainObject</span><span class="token punctuation">(</span>toVal<span class="token punctuation">)</span> <span class="token operator">&amp;&amp;</span> <span class="token function">isPlainObject</span><span class="token punctuation">(</span>fromVal<span class="token punctuation">)</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
			<span class="token comment">// 处理深层对象，当合并的数据为多层嵌套对象时，需要递归调用mergeData进行比较合并</span>
			<span class="token function">mergeData</span><span class="token punctuation">(</span>toVal<span class="token punctuation">,</span> fromVal<span class="token punctuation">)</span>
		<span class="token punctuation">}</span>
	<span class="token punctuation">}</span>
	<span class="token keyword">return</span> to
<span class="token punctuation">}</span>
Copy
</code></pre></div><p><code>mergeData</code>方法的两个参数是父<code>data</code>选项和子<code>data</code>选项的结果，也就是两个<code>data</code>对象，从源码上看数据合并的原则是，将父类的数据整合到子类的数据选项中， 如若父类数据和子类数据冲突时，保留子类数据。如果对象有深层嵌套，则需要递归调用<code>mergeData</code>进行数据合并。</p> <p>最后回过头来思考一个问题，为什么<code>Vue</code>组件的<code>data</code>是一个函数，而不是一个对象呢？ 我觉得可以这样解释：<strong>组件设计的目的是为了复用，每次通过函数创建相当于在一个独立的内存空间中生成一个<code>data</code>的副本，这样每个组件之间的数据不会互相影响。</strong></p> <h3 id="自带资源选项合并"><a href="#自带资源选项合并" class="header-anchor">#</a> 自带资源选项合并</h3> <p>在 1.2 中我们看到了<code>Vue</code>默认会带几个选项，分别是<code>components</code>组件, <code>directive</code>指令, <code>filter</code>过滤器,所有无论是根实例，还是父子实例，都需要和系统自带的资源选项进行合并。它的定义如下：</p> <div class="language-js extra-class"><pre class="language-js"><code><span class="token comment">// 资源选项</span>
<span class="token keyword">var</span> <span class="token constant">ASSET_TYPES</span> <span class="token operator">=</span> <span class="token punctuation">[</span><span class="token string">'component'</span><span class="token punctuation">,</span> <span class="token string">'directive'</span><span class="token punctuation">,</span> <span class="token string">'filter'</span><span class="token punctuation">]</span>

<span class="token comment">// 定义资源合并的策略</span>
<span class="token constant">ASSET_TYPES</span><span class="token punctuation">.</span><span class="token function">forEach</span><span class="token punctuation">(</span><span class="token keyword">function</span><span class="token punctuation">(</span><span class="token parameter">type</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
	strats<span class="token punctuation">[</span>type <span class="token operator">+</span> <span class="token string">'s'</span><span class="token punctuation">]</span> <span class="token operator">=</span> mergeAssets <span class="token comment">// 定义默认策略</span>
<span class="token punctuation">}</span><span class="token punctuation">)</span>
Copy
</code></pre></div><p>这些资源选项的合并逻辑很简单，首先会创建一个原型指向父类资源选项的空对象，再将子类选项赋值给空对象。</p> <div class="language-js extra-class"><pre class="language-js"><code><span class="token comment">// 资源选项自定义合并策略</span>
<span class="token keyword">function</span> <span class="token function">mergeAssets</span><span class="token punctuation">(</span><span class="token parameter">parentVal<span class="token punctuation">,</span> childVal<span class="token punctuation">,</span> vm<span class="token punctuation">,</span> key</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
	<span class="token keyword">var</span> res <span class="token operator">=</span> Object<span class="token punctuation">.</span><span class="token function">create</span><span class="token punctuation">(</span>parentVal <span class="token operator">||</span> <span class="token keyword">null</span><span class="token punctuation">)</span> <span class="token comment">// 创建一个空对象，其原型指向父类的资源选项。</span>
	<span class="token keyword">if</span> <span class="token punctuation">(</span>childVal<span class="token punctuation">)</span> <span class="token punctuation">{</span>
		<span class="token function">assertObjectType</span><span class="token punctuation">(</span>key<span class="token punctuation">,</span> childVal<span class="token punctuation">,</span> vm<span class="token punctuation">)</span> <span class="token comment">// components,filters,directives选项必须为对象</span>
		<span class="token keyword">return</span> <span class="token function">extend</span><span class="token punctuation">(</span>res<span class="token punctuation">,</span> childVal<span class="token punctuation">)</span> <span class="token comment">// 子类选项赋值给空对象</span>
	<span class="token punctuation">}</span> <span class="token keyword">else</span> <span class="token punctuation">{</span>
		<span class="token keyword">return</span> res
	<span class="token punctuation">}</span>
<span class="token punctuation">}</span>
</code></pre></div><p>结合下面的例子，我们看具体合并后的结果：</p> <div class="language-js extra-class"><pre class="language-js"><code><span class="token keyword">var</span> vm <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token class-name">Vue</span><span class="token punctuation">(</span><span class="token punctuation">{</span>
  components<span class="token operator">:</span> <span class="token punctuation">{</span>
    componentA<span class="token operator">:</span> <span class="token punctuation">{</span><span class="token punctuation">}</span>
  <span class="token punctuation">}</span><span class="token punctuation">,</span>
  directives<span class="token operator">:</span> <span class="token punctuation">{</span>
    <span class="token string">'v-boom'</span><span class="token operator">:</span> <span class="token punctuation">{</span><span class="token punctuation">}</span>
  <span class="token punctuation">}</span>
<span class="token punctuation">}</span><span class="token punctuation">)</span>

console<span class="token punctuation">.</span><span class="token function">log</span><span class="token punctuation">(</span>vm<span class="token punctuation">.</span>$options<span class="token punctuation">.</span>components<span class="token punctuation">)</span>
<span class="token comment">// 根实例的选项和资源默认选项合并后的结果</span>
<span class="token punctuation">{</span>
  components<span class="token operator">:</span> <span class="token punctuation">{</span>
    componentA<span class="token operator">:</span> <span class="token punctuation">{</span><span class="token punctuation">}</span><span class="token punctuation">,</span>
    __proto__<span class="token operator">:</span> <span class="token punctuation">{</span>
      KeepAlive<span class="token operator">:</span> <span class="token punctuation">{</span><span class="token punctuation">}</span>
      Transition<span class="token operator">:</span> <span class="token punctuation">{</span><span class="token punctuation">}</span>
      TransitionGroup<span class="token operator">:</span> <span class="token punctuation">{</span><span class="token punctuation">}</span>
    <span class="token punctuation">}</span>
  <span class="token punctuation">}</span><span class="token punctuation">,</span>
  directives<span class="token operator">:</span> <span class="token punctuation">{</span>
    <span class="token string">'v-boom'</span><span class="token operator">:</span> <span class="token punctuation">{</span><span class="token punctuation">}</span><span class="token punctuation">,</span>
    __proto__<span class="token operator">:</span> <span class="token punctuation">{</span>
      <span class="token string">'v-show'</span><span class="token operator">:</span> <span class="token punctuation">{</span><span class="token punctuation">}</span><span class="token punctuation">,</span>
      <span class="token string">'v-model'</span><span class="token operator">:</span> <span class="token punctuation">{</span><span class="token punctuation">}</span>
    <span class="token punctuation">}</span>
  <span class="token punctuation">}</span>
<span class="token punctuation">}</span>
</code></pre></div><p>简单总结一下，对于 <code>directives、filters</code> 以及 <code>components</code> 等资源选项，父类选项将以原型链的形式被处理。子类必须通过原型链才能查找并使用内置组件和内置指令。</p> <h3 id="生命周期钩子函数的合并"><a href="#生命周期钩子函数的合并" class="header-anchor">#</a> 生命周期钩子函数的合并</h3> <p>在学习<code>Vue</code>时，有一个重要的思想，生命周期。它是我们使用<code>Vue</code>高效开发组件的基础，我们可以在组件实例的不同阶段去定义需要执行的函数，让组件的功能更加丰富。在介绍生命周期钩子函数的选项合并前，我们有必要复习以下官方的生命周期图。</p> <img src="/my_boke/lifecycle.png" alt="vue声明周期" style="zoom:50%;"> <p>然而从源码中我们可以看到<code>Vue</code>的生命周期钩子不止这些，它有多达 12 个之多，每个钩子的执行时机我们暂且不深究，它们会在以后的章节中逐一出现。我们关心的是：子父组件的生命周期钩子函数是遵循什么样的规则合并。</p> <div class="language-js extra-class"><pre class="language-js"><code><span class="token keyword">var</span> <span class="token constant">LIFECYCLE_HOOKS</span> <span class="token operator">=</span> <span class="token punctuation">[</span>
	<span class="token string">'beforeCreate'</span><span class="token punctuation">,</span>
	<span class="token string">'created'</span><span class="token punctuation">,</span>
	<span class="token string">'beforeMount'</span><span class="token punctuation">,</span>
	<span class="token string">'mounted'</span><span class="token punctuation">,</span>
	<span class="token string">'beforeUpdate'</span><span class="token punctuation">,</span>
	<span class="token string">'updated'</span><span class="token punctuation">,</span>
	<span class="token string">'beforeDestroy'</span><span class="token punctuation">,</span>
	<span class="token string">'destroyed'</span><span class="token punctuation">,</span>
	<span class="token string">'activated'</span><span class="token punctuation">,</span>
	<span class="token string">'deactivated'</span><span class="token punctuation">,</span>
	<span class="token string">'errorCaptured'</span><span class="token punctuation">,</span>
	<span class="token string">'serverPrefetch'</span><span class="token punctuation">,</span>
<span class="token punctuation">]</span>
<span class="token constant">LIFECYCLE_HOOKS</span><span class="token punctuation">.</span><span class="token function">forEach</span><span class="token punctuation">(</span><span class="token keyword">function</span><span class="token punctuation">(</span><span class="token parameter">hook</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
	strats<span class="token punctuation">[</span>hook<span class="token punctuation">]</span> <span class="token operator">=</span> mergeHook <span class="token comment">// 对生命周期钩子选项的合并都执行mergeHook策略</span>
<span class="token punctuation">}</span><span class="token punctuation">)</span>
Copy
</code></pre></div><p><code>mergeHook</code>是生命周期钩子合并的策略，简单的对代码进行总结，钩子函数的合并原则是：</p> <ol><li>如果子类和父类都拥有相同钩子选项，则将子类选项和父类选项合并。</li> <li>如果父类不存在钩子选项，子类存在时，则以数组形式返回子类钩子选项。</li> <li>当子类不存在钩子选项时，则以父类选项返回。</li> <li>子父合并时，是将子类选项放在数组的末尾，这样在执行钩子时，永远是父类选项优先于子类选项执行。</li></ol> <div class="language-js extra-class"><pre class="language-js"><code><span class="token comment">// 生命周期钩子选项合并策略</span>
<span class="token keyword">function</span> <span class="token function">mergeHook</span><span class="token punctuation">(</span><span class="token parameter">parentVal<span class="token punctuation">,</span> childVal</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
	<span class="token comment">// 1.如果子类和父类都拥有钩子选项，则将子类选项和父类选项合并,</span>
	<span class="token comment">// 2.如果父类不存在钩子选项，子类存在时，则以数组形式返回子类钩子选项，</span>
	<span class="token comment">// 3.当子类不存在钩子选项时，则以父类选项返回。</span>
	<span class="token keyword">var</span> res <span class="token operator">=</span> childVal
		<span class="token operator">?</span> parentVal
			<span class="token operator">?</span> parentVal<span class="token punctuation">.</span><span class="token function">concat</span><span class="token punctuation">(</span>childVal<span class="token punctuation">)</span>
			<span class="token operator">:</span> Array<span class="token punctuation">.</span><span class="token function">isArray</span><span class="token punctuation">(</span>childVal<span class="token punctuation">)</span>
			<span class="token operator">?</span> childVal
			<span class="token operator">:</span> <span class="token punctuation">[</span>childVal<span class="token punctuation">]</span>
		<span class="token operator">:</span> parentVal
	<span class="token keyword">return</span> res <span class="token operator">?</span> <span class="token function">dedupeHooks</span><span class="token punctuation">(</span>res<span class="token punctuation">)</span> <span class="token operator">:</span> res
<span class="token punctuation">}</span>
<span class="token comment">// 防止多个组件实例钩子选项相互影响</span>
<span class="token keyword">function</span> <span class="token function">dedupeHooks</span><span class="token punctuation">(</span><span class="token parameter">hooks</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
	<span class="token keyword">var</span> res <span class="token operator">=</span> <span class="token punctuation">[</span><span class="token punctuation">]</span>
	<span class="token keyword">for</span> <span class="token punctuation">(</span><span class="token keyword">var</span> i <span class="token operator">=</span> <span class="token number">0</span><span class="token punctuation">;</span> i <span class="token operator">&lt;</span> hooks<span class="token punctuation">.</span>length<span class="token punctuation">;</span> i<span class="token operator">++</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
		<span class="token keyword">if</span> <span class="token punctuation">(</span>res<span class="token punctuation">.</span><span class="token function">indexOf</span><span class="token punctuation">(</span>hooks<span class="token punctuation">[</span>i<span class="token punctuation">]</span><span class="token punctuation">)</span> <span class="token operator">===</span> <span class="token operator">-</span><span class="token number">1</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
			res<span class="token punctuation">.</span><span class="token function">push</span><span class="token punctuation">(</span>hooks<span class="token punctuation">[</span>i<span class="token punctuation">]</span><span class="token punctuation">)</span>
		<span class="token punctuation">}</span>
	<span class="token punctuation">}</span>
	<span class="token keyword">return</span> res
<span class="token punctuation">}</span>
</code></pre></div><p>下面结合具体的例子看合并结果。</p> <div class="language-js extra-class"><pre class="language-js"><code><span class="token keyword">var</span> Parent <span class="token operator">=</span> Vue<span class="token punctuation">.</span><span class="token function">extend</span><span class="token punctuation">(</span><span class="token punctuation">{</span>
	<span class="token function">mounted</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
		console<span class="token punctuation">.</span><span class="token function">log</span><span class="token punctuation">(</span><span class="token string">'parent'</span><span class="token punctuation">)</span>
	<span class="token punctuation">}</span><span class="token punctuation">,</span>
<span class="token punctuation">}</span><span class="token punctuation">)</span>
<span class="token keyword">var</span> Child <span class="token operator">=</span> Parent<span class="token punctuation">.</span><span class="token function">extend</span><span class="token punctuation">(</span><span class="token punctuation">{</span>
	<span class="token function">mounted</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
		console<span class="token punctuation">.</span><span class="token function">log</span><span class="token punctuation">(</span><span class="token string">'child'</span><span class="token punctuation">)</span>
	<span class="token punctuation">}</span><span class="token punctuation">,</span>
<span class="token punctuation">}</span><span class="token punctuation">)</span>
<span class="token keyword">var</span> vm <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token class-name">Child</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">$mount</span><span class="token punctuation">(</span><span class="token string">'#app'</span><span class="token punctuation">)</span>

<span class="token comment">// 输出结果： parent child</span>
</code></pre></div><p>简单总结一下：<strong>对于生命周期钩子选项，子类和父类相同的选项将合并成数组，这样在执行子类钩子函数时，父类钩子选项也会执行，并且父会优先于子执行。</strong></p> <h3 id="watch-选项合并"><a href="#watch-选项合并" class="header-anchor">#</a> watch 选项合并</h3> <p>在使用<code>Vue</code>进行开发时，我们有时需要自定义侦听器来响应数据的变化，当需要在数据变化时执行异步或者开销较大的操作时，<code>watch</code>往往是高效的。对于 <code>watch</code> 选项的合并处理，它类似于生命周期钩子，只要父选项有相同的观测字段，则和子的选项合并为数组，在监测字段改变时同时执行父类选项的监听代码。处理方式和生命钩子选项的区别在于，生命周期钩子选项必须是函数，而<code>watch</code>选项最终在合并的数组中可以是包含选项的对象，也可以是对应的回调函数，或者方法名。</p> <div class="language-js extra-class"><pre class="language-js"><code>strats<span class="token punctuation">.</span><span class="token function-variable function">watch</span> <span class="token operator">=</span> <span class="token keyword">function</span><span class="token punctuation">(</span><span class="token parameter">parentVal<span class="token punctuation">,</span> childVal<span class="token punctuation">,</span> vm<span class="token punctuation">,</span> key</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
	<span class="token comment">//火狐浏览器在Object的原型上拥有watch方法，这里对这一现象做了兼容</span>
	<span class="token comment">// var nativeWatch = ({}).watch;</span>
	<span class="token keyword">if</span> <span class="token punctuation">(</span>parentVal <span class="token operator">===</span> nativeWatch<span class="token punctuation">)</span> <span class="token punctuation">{</span>
		parentVal <span class="token operator">=</span> <span class="token keyword">undefined</span>
	<span class="token punctuation">}</span>
	<span class="token keyword">if</span> <span class="token punctuation">(</span>childVal <span class="token operator">===</span> nativeWatch<span class="token punctuation">)</span> <span class="token punctuation">{</span>
		childVal <span class="token operator">=</span> <span class="token keyword">undefined</span>
	<span class="token punctuation">}</span>
	<span class="token comment">// 没有子，则默认用父选项</span>
	<span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token operator">!</span>childVal<span class="token punctuation">)</span> <span class="token punctuation">{</span>
		<span class="token keyword">return</span> Object<span class="token punctuation">.</span><span class="token function">create</span><span class="token punctuation">(</span>parentVal <span class="token operator">||</span> <span class="token keyword">null</span><span class="token punctuation">)</span>
	<span class="token punctuation">}</span>
	<span class="token punctuation">{</span>
		<span class="token comment">// 保证watch选项是一个对象</span>
		<span class="token function">assertObjectType</span><span class="token punctuation">(</span>key<span class="token punctuation">,</span> childVal<span class="token punctuation">,</span> vm<span class="token punctuation">)</span>
	<span class="token punctuation">}</span>
	<span class="token comment">// 没有父则直接用子选项</span>
	<span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token operator">!</span>parentVal<span class="token punctuation">)</span> <span class="token punctuation">{</span>
		<span class="token keyword">return</span> childVal
	<span class="token punctuation">}</span>
	<span class="token keyword">var</span> ret <span class="token operator">=</span> <span class="token punctuation">{</span><span class="token punctuation">}</span>
	<span class="token function">extend</span><span class="token punctuation">(</span>ret<span class="token punctuation">,</span> parentVal<span class="token punctuation">)</span>
	<span class="token keyword">for</span> <span class="token punctuation">(</span><span class="token keyword">var</span> key <span class="token keyword">in</span> childVal<span class="token punctuation">)</span> <span class="token punctuation">{</span>
		<span class="token keyword">var</span> parent <span class="token operator">=</span> ret<span class="token punctuation">[</span>key<span class="token punctuation">]</span>
		<span class="token keyword">var</span> child <span class="token operator">=</span> childVal<span class="token punctuation">[</span>key<span class="token punctuation">]</span>
		<span class="token comment">// 父的选项先转换成数组</span>
		<span class="token keyword">if</span> <span class="token punctuation">(</span>parent <span class="token operator">&amp;&amp;</span> <span class="token operator">!</span>Array<span class="token punctuation">.</span><span class="token function">isArray</span><span class="token punctuation">(</span>parent<span class="token punctuation">)</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
			parent <span class="token operator">=</span> <span class="token punctuation">[</span>parent<span class="token punctuation">]</span>
		<span class="token punctuation">}</span>
		ret<span class="token punctuation">[</span>key<span class="token punctuation">]</span> <span class="token operator">=</span> parent <span class="token operator">?</span> parent<span class="token punctuation">.</span><span class="token function">concat</span><span class="token punctuation">(</span>child<span class="token punctuation">)</span> <span class="token operator">:</span> Array<span class="token punctuation">.</span><span class="token function">isArray</span><span class="token punctuation">(</span>child<span class="token punctuation">)</span> <span class="token operator">?</span> child <span class="token operator">:</span> <span class="token punctuation">[</span>child<span class="token punctuation">]</span>
	<span class="token punctuation">}</span>
	<span class="token keyword">return</span> ret
<span class="token punctuation">}</span>
</code></pre></div><p>下面结合具体的例子看合并结果：</p> <div class="language-js extra-class"><pre class="language-js"><code><span class="token keyword">var</span> Parent <span class="token operator">=</span> Vue<span class="token punctuation">.</span><span class="token function">extend</span><span class="token punctuation">(</span><span class="token punctuation">{</span>
	watch<span class="token operator">:</span> <span class="token punctuation">{</span>
		<span class="token function-variable function">test</span><span class="token operator">:</span> <span class="token keyword">function</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
			console<span class="token punctuation">.</span><span class="token function">log</span><span class="token punctuation">(</span><span class="token string">'parent change'</span><span class="token punctuation">)</span>
		<span class="token punctuation">}</span><span class="token punctuation">,</span>
	<span class="token punctuation">}</span><span class="token punctuation">,</span>
<span class="token punctuation">}</span><span class="token punctuation">)</span>
<span class="token keyword">var</span> Child <span class="token operator">=</span> Parent<span class="token punctuation">.</span><span class="token function">extend</span><span class="token punctuation">(</span><span class="token punctuation">{</span>
	watch<span class="token operator">:</span> <span class="token punctuation">{</span>
		test<span class="token operator">:</span> <span class="token punctuation">{</span>
			<span class="token function-variable function">handler</span><span class="token operator">:</span> <span class="token keyword">function</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
				console<span class="token punctuation">.</span><span class="token function">log</span><span class="token punctuation">(</span><span class="token string">'child change'</span><span class="token punctuation">)</span>
			<span class="token punctuation">}</span><span class="token punctuation">,</span>
		<span class="token punctuation">}</span><span class="token punctuation">,</span>
	<span class="token punctuation">}</span><span class="token punctuation">,</span>
	<span class="token function">data</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
		<span class="token keyword">return</span> <span class="token punctuation">{</span>
			test<span class="token operator">:</span> <span class="token number">1</span><span class="token punctuation">,</span>
		<span class="token punctuation">}</span>
	<span class="token punctuation">}</span><span class="token punctuation">,</span>
<span class="token punctuation">}</span><span class="token punctuation">)</span>
<span class="token keyword">var</span> vm <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token class-name">Child</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">$mount</span><span class="token punctuation">(</span><span class="token string">'#app'</span><span class="token punctuation">)</span>
vm<span class="token punctuation">.</span>test <span class="token operator">=</span> <span class="token number">2</span>
<span class="token comment">// 输出结果</span>
<span class="token comment">// parent change</span>
<span class="token comment">// child change</span>
</code></pre></div><p>简单总结一下：<strong>对于 watch 选项的合并，最终和父类选项合并成数组，并且数组的选项成员，可以是回调函数，选项对象，或者函数名。</strong></p> <h3 id="props-methods-inject-computed-合并"><a href="#props-methods-inject-computed-合并" class="header-anchor">#</a> props，methods，inject，computed 合并</h3> <p>源码的设计将<code>props.methods,inject,computed</code>归结为一类，他们的配置策略一致，简单概括就是，如果父类不存在选项，则返回子类选项，子类父类都存在时，用子类选项去覆盖父类选项。</p> <div class="language-js extra-class"><pre class="language-js"><code><span class="token comment">// 其他选项合并策略</span>
strats<span class="token punctuation">.</span>props <span class="token operator">=</span> strats<span class="token punctuation">.</span>methods <span class="token operator">=</span> strats<span class="token punctuation">.</span>inject <span class="token operator">=</span> strats<span class="token punctuation">.</span><span class="token function-variable function">computed</span> <span class="token operator">=</span> <span class="token keyword">function</span><span class="token punctuation">(</span><span class="token parameter">parentVal<span class="token punctuation">,</span> childVal<span class="token punctuation">,</span> vm<span class="token punctuation">,</span> key</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
	<span class="token keyword">if</span> <span class="token punctuation">(</span>childVal <span class="token operator">&amp;&amp;</span> <span class="token string">'development'</span> <span class="token operator">!==</span> <span class="token string">'production'</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
		<span class="token function">assertObjectType</span><span class="token punctuation">(</span>key<span class="token punctuation">,</span> childVal<span class="token punctuation">,</span> vm<span class="token punctuation">)</span>
	<span class="token punctuation">}</span>
	<span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token operator">!</span>parentVal<span class="token punctuation">)</span> <span class="token punctuation">{</span>
		<span class="token keyword">return</span> childVal
	<span class="token punctuation">}</span> <span class="token comment">// 父类不存在该选项，则返回子类的选项</span>
	<span class="token keyword">var</span> ret <span class="token operator">=</span> Object<span class="token punctuation">.</span><span class="token function">create</span><span class="token punctuation">(</span><span class="token keyword">null</span><span class="token punctuation">)</span>
	<span class="token function">extend</span><span class="token punctuation">(</span>ret<span class="token punctuation">,</span> parentVal<span class="token punctuation">)</span> <span class="token comment">//</span>
	<span class="token keyword">if</span> <span class="token punctuation">(</span>childVal<span class="token punctuation">)</span> <span class="token punctuation">{</span>
		<span class="token comment">// 子类选项会覆盖父类选项的值</span>
		<span class="token function">extend</span><span class="token punctuation">(</span>ret<span class="token punctuation">,</span> childVal<span class="token punctuation">)</span>
	<span class="token punctuation">}</span>
	<span class="token keyword">return</span> ret
<span class="token punctuation">}</span>
Copy
</code></pre></div><h3 id="小结"><a href="#小结" class="header-anchor">#</a> 小结</h3> <p>至此，五类选项合并的策略分析到此结束，回顾一下这一章节的内容，这一节是<code>Vue</code>源码分析的起手式，所以我们从<code>Vue</code>的引入出发，先大致了解了<code>Vue</code>在代码引入阶段做的操作，主要是对静态属性方法和原型上属性方法的定义和声明，这里并不需要精确了解到每个方法的功能和实现细节，当然我也相信你已经在实战中或多或少接触过这些方法的使用。接下来到文章的重点，<code>new Vue</code>是我们正确使用<code>Vue</code>进行开发的关键，而实例化阶段会对调用<code>_init</code>方法进行初始化，选项合并是初始化的第一步。选项合并会对系统内部定义的选项和子父类的选项进行合并。而<code>Vue</code>有相当丰富的选项合并策略，不管是内部的选项还是用户自定义的选项，他们都遵循内部约定好的合并策略。有了丰富的选项和严格的合并策略，<code>Vue</code>在指导开发上才显得更加完备。下一节会分析一个重要的概念，数据代理，它也是响应式系统的基础。</p> <h2 id="基础的数据代理检测"><a href="#基础的数据代理检测" class="header-anchor">#</a> 基础的数据代理检测</h2> <h3 id="数据代理的含义"><a href="#数据代理的含义" class="header-anchor">#</a> 数据代理的含义</h3> <p>数据代理的另一个说法是数据劫持，当我们在访问或者修改对象的某个属性时，数据劫持可以拦截这个行为并进行额外的操作或者修改返回的结果。而我们知道<code>Vue</code>响应式系统的核心就是数据代理，代理使得数据在访问时进行依赖收集，在修改更新时对依赖进行更新，这是响应式系统的核心思路。而这一切离不开<code>Vue</code>对数据做了拦截代理。在分析之前，我们需要掌握两种实现数据代理的方法： <code>Object.defineProperty</code> 和 <code>Proxy</code>。</p> <h3 id="object-defineproperty"><a href="#object-defineproperty" class="header-anchor">#</a> Object.defineProperty</h3> <p>官方定义：<code>Object.defineProperty()</code>方法会直接在一个对象上定义一个新属性，或者修改一个对象的现有属性， 并返回这个对象。</p> <p>基本用法：</p> <div class="language-js extra-class"><pre class="language-js"><code>Object<span class="token punctuation">.</span><span class="token function">defineProperty</span><span class="token punctuation">(</span>obj<span class="token punctuation">,</span> prop<span class="token punctuation">,</span> descriptor<span class="token punctuation">)</span>
</code></pre></div><p><code>Object.defineProperty()</code>可以用来精确添加或修改对象的属性，只需要在<code>descriptor</code>对象中将属性特性描述清楚，<code>descriptor</code>的属性描述符有两种形式，一种是数据描述符，另一种是存取描述符，我们分别看看各自的特点。</p> <p>数据描述符，它拥有四个属性配置</p> <ol><li><code>configurable</code>：数据是否可删除，可配置</li> <li><code>enumerable</code>：属性是否可枚举</li> <li><code>value</code>：属性值,默认为<code>undefined</code></li> <li><code>writable</code>：属性是否可读写</li></ol> <p>存取描述符，它同样拥有四个属性选项</p> <ol><li><code>configurable</code>：数据是否可删除，可配置</li> <li><code>enumerable</code>：属性是否可枚举</li> <li><code>get</code>:一个给属性提供 <code>getter</code> 的方法，如果没有 <code>getter</code> 则为 <code>undefined</code>。</li> <li><code>set</code>:一个给属性提供 <code>setter</code> 的方法，如果没有 <code>setter</code> 则为 <code>undefined</code>。</li></ol> <p><strong>需要注意的是: 数据描述符的<code>value，writable</code> 和 存取描述符中的<code>get, set</code>属性不能同时存在，否则会抛出异常。</strong> 有了<code>Object.defineProperty</code>方法，我们可以方便的利用存取描述符中的<code>getter/setter</code>来进行数据的监听,这也是响应式构建的雏形。<code>getter</code>方法可以让我们在访问数据时做额外的操作处理，<code>setter</code>方法使得我们可以在数据更新时修改返回的结果。看看下面的例子,由于设置了数据代理，当我们访问对象<code>o</code>的<code>a</code>属性时，会触发<code>getter</code>执行钩子函数，当修改<code>a</code>属性的值时，会触发<code>setter</code>钩子函数去修改返回的结果。</p> <div class="language-js extra-class"><pre class="language-js"><code><span class="token keyword">var</span> o <span class="token operator">=</span> <span class="token punctuation">{</span><span class="token punctuation">}</span>
<span class="token keyword">var</span> value<span class="token punctuation">;</span>
Object<span class="token punctuation">.</span><span class="token function">defineProperty</span><span class="token punctuation">(</span>o<span class="token punctuation">,</span> <span class="token string">'a'</span><span class="token punctuation">,</span> <span class="token punctuation">{</span>
    <span class="token function">get</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
        console<span class="token punctuation">.</span><span class="token function">log</span><span class="token punctuation">(</span><span class="token string">'获取值'</span><span class="token punctuation">)</span>
        <span class="token keyword">return</span> value
    <span class="token punctuation">}</span><span class="token punctuation">,</span>
    <span class="token function">set</span><span class="token punctuation">(</span>v<span class="token punctuation">)</span> <span class="token punctuation">{</span>
        console<span class="token punctuation">.</span><span class="token function">log</span><span class="token punctuation">(</span><span class="token string">'设置值'</span><span class="token punctuation">)</span>
        value <span class="token operator">=</span> <span class="token string">'qqq'</span>
    <span class="token punctuation">}</span>
<span class="token punctuation">}</span><span class="token punctuation">)</span>
o<span class="token punctuation">.</span>a <span class="token operator">=</span> <span class="token string">'sss'</span> 
console<span class="token punctuation">.</span><span class="token function">log</span><span class="token punctuation">(</span>o<span class="token punctuation">.</span>a<span class="token punctuation">)</span>
<span class="token comment">// 设置值</span>
<span class="token comment">// 获取值</span>
<span class="token comment">// 'qqq'</span>
</code></pre></div><p>前面说到<code>Object.defineProperty</code>的<code>get</code>和<code>set</code>方法是对对象进行监测并响应变化，那么数组类型是否也可以监测呢，参照监听属性的思路，我们用数组的下标作为属性，数组的元素作为拦截对象，看看<code>Object.defineProperty</code>是否可以对数组的数据进行监控拦截。</p> <div class="language-js extra-class"><pre class="language-js"><code><span class="token keyword">var</span> arr <span class="token operator">=</span> <span class="token punctuation">[</span><span class="token number">1</span><span class="token punctuation">,</span><span class="token number">2</span><span class="token punctuation">,</span><span class="token number">3</span><span class="token punctuation">]</span><span class="token punctuation">;</span>
arr<span class="token punctuation">.</span><span class="token function">forEach</span><span class="token punctuation">(</span><span class="token punctuation">(</span><span class="token parameter">item<span class="token punctuation">,</span> index</span><span class="token punctuation">)</span> <span class="token operator">=&gt;</span> <span class="token punctuation">{</span>
    Object<span class="token punctuation">.</span><span class="token function">defineProperty</span><span class="token punctuation">(</span>arr<span class="token punctuation">,</span> index<span class="token punctuation">,</span> <span class="token punctuation">{</span>
        <span class="token function">get</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
            console<span class="token punctuation">.</span><span class="token function">log</span><span class="token punctuation">(</span><span class="token string">'数组被getter拦截'</span><span class="token punctuation">)</span>
            <span class="token keyword">return</span> item
        <span class="token punctuation">}</span><span class="token punctuation">,</span>
        <span class="token function">set</span><span class="token punctuation">(</span>value<span class="token punctuation">)</span> <span class="token punctuation">{</span>
            console<span class="token punctuation">.</span><span class="token function">log</span><span class="token punctuation">(</span><span class="token string">'数组被setter拦截'</span><span class="token punctuation">)</span>
            <span class="token keyword">return</span> item <span class="token operator">=</span> value
        <span class="token punctuation">}</span>
    <span class="token punctuation">}</span><span class="token punctuation">)</span>
<span class="token punctuation">}</span><span class="token punctuation">)</span>

arr<span class="token punctuation">[</span><span class="token number">1</span><span class="token punctuation">]</span> <span class="token operator">=</span> <span class="token number">4</span><span class="token punctuation">;</span>
console<span class="token punctuation">.</span><span class="token function">log</span><span class="token punctuation">(</span>arr<span class="token punctuation">)</span>
<span class="token comment">// 结果</span>
<span class="token comment">// 数组被setter拦截</span>
<span class="token comment">// 数组被getter拦截</span>
<span class="token comment">// 4</span>
</code></pre></div><p>显然，**已知长度的数组是可以通过索引属性来设置属性的访问器属性的。**但是数组的添加确无法进行拦截，这个也很好理解，不管是通过<code>arr.push()</code>还是<code>arr[10] = 10</code>添加的数据，数组所添加的索引值并没有预先加入数据拦截中，所以自然无法进行拦截处理。这个也是使用<code>Object.defineProperty</code>进行数据代理的弊端。为了解决这个问题，<code>Vue</code>在响应式系统中对数组的方法进行了重写，间接的解决了这个问题</p> <p>另外如果需要拦截的对象属性嵌套多层，如果没有递归去调用<code>Object.defineProperty</code>进行拦截，深层次的数据也依然无法监测。</p></div> <footer class="page-edit"><!----> <!----></footer> <!----> </main></div><div class="global-ui"><!----></div></div>
    <script src="/my_boke/assets/js/app.5a7cfdf9.js" defer></script><script src="/my_boke/assets/js/2.1e45f81f.js" defer></script><script src="/my_boke/assets/js/24.bfdc09b5.js" defer></script>
  </body>
</html>
